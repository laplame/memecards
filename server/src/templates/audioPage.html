<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <meta name="description" content="{{DESCRIPTION}}">
  <title>{{TITLE}}</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 800"><defs><linearGradient id="bg" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:%23fce7f3;stop-opacity:1" /><stop offset="100%" style="stop-color:%23fdf2f8;stop-opacity:1" /></linearGradient></defs><rect width="1200" height="800" fill="url(%23bg)"/></svg>') no-repeat center center fixed;
      background-size: cover;
      background-color: #fce7f3;
      min-height: 100vh;
      position: relative;
      padding: 20px;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, var(--overlay-opacity, 0.3));
      backdrop-filter: blur(10px);
      z-index: 0;
      pointer-events: none; /* Permitir interacci√≥n con elementos debajo */
    }
    
    body.has-wallpaper::before {
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(5px);
    }

    .back-button {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 100;
      color: #333;
      text-decoration: none;
      font-size: 16px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 5px;
      background: rgba(255, 255, 255, 0.9);
      padding: 10px 15px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      transition: all 0.3s;
    }

    .back-button:hover {
      background: rgba(255, 255, 255, 1);
      transform: translateX(-3px);
    }

    .header {
      background: linear-gradient(135deg, #ec4899 0%, #ef4444 100%);
      padding: 60px 20px 40px;
      text-align: center;
      position: relative;
      z-index: 1;
      width: 100%;
      box-sizing: border-box;
      border-radius: 0 0 30px 30px;
      margin-bottom: -30px;
    }

    .heart-icon {
      width: 60px;
      height: 60px;
      margin: 0 auto 20px;
      background: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .header h1 {
      color: white;
      font-size: 32px;
      font-weight: 700;
      margin: 0;
      transition: all 0.3s ease;
      min-height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .header h1.warning {
      animation: pulse-warning 2s infinite;
    }

    .header h1.danger {
      animation: pulse-danger 1.5s infinite;
    }

    @keyframes pulse-warning {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
    }

    @keyframes pulse-danger {
      0%, 100% {
        transform: scale(1);
        color: white;
      }
      50% {
        transform: scale(1.1);
        color: #ffeb3b;
      }
    }

    @keyframes spin {
      from {
        transform: rotate(0deg);
      }
      to {
        transform: rotate(360deg);
      }
    }

    @keyframes pulse-dot {
      0%, 80%, 100% {
        transform: scale(0.8);
        opacity: 0.5;
      }
      40% {
        transform: scale(1.2);
        opacity: 1;
      }
    }

    .container {
      position: relative;
      z-index: 10;
      max-width: 500px;
      width: 100%;
      margin: 0 auto;
      padding-bottom: 20px;
      box-sizing: border-box;
    }

    footer {
      position: relative;
      z-index: 2;
    }

    .form-container {
      background: white;
      border-radius: 25px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
      padding: 50px 30px 30px;
      margin-top: 30px;
    }

    .form-group {
      margin-bottom: 25px;
    }

    .form-group label {
      display: block;
      margin-bottom: 10px;
      color: #333;
      font-weight: 600;
      font-size: 15px;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 14px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 16px;
      font-family: inherit;
      transition: all 0.3s;
      background: #f9fafb;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #ec4899;
      background: white;
      box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.1);
    }

    .form-group textarea {
      resize: vertical;
      min-height: 120px;
    }

    .record-button {
      width: 100%;
      padding: 18px 24px;
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
    }

    .record-button:hover {
      background: #dc2626;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
    }

    .record-button:active {
      transform: translateY(0);
    }

    .record-button.recording {
      background: #dc2626;
      animation: pulse 1.5s infinite;
    }

    .record-button.stop {
      background: #dc2626;
    }

    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.7;
      }
    }

    .audio-preview {
      margin-top: 15px;
      padding: 15px;
      background: #f9fafb;
      border-radius: 12px;
      border: 2px solid #e5e7eb;
      display: none;
    }

    .audio-preview.active {
      display: block;
    }

    .audio-preview audio {
      width: 100%;
      margin-top: 10px;
    }

    .audio-info {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .audio-info span {
      font-size: 14px;
      color: #666;
    }

    .submit-button {
      width: 100%;
      padding: 18px;
      background: linear-gradient(135deg, #ec4899 0%, #ef4444 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 20px;
      box-shadow: 0 4px 15px rgba(236, 72, 153, 0.4);
    }

    .submit-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(236, 72, 153, 0.5);
    }

    .submit-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .status-message {
      margin-top: 15px;
      padding: 12px;
      border-radius: 10px;
      font-size: 14px;
      text-align: center;
      display: none;
    }

    .status-message.active {
      display: block;
    }

    .status-message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status-message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .status-message.loading {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }

    /* Estado de Personalizaci√≥n */
    .personalization-form {
      display: none;
    }

    .personalization-form.active {
      display: block;
    }

    /* Estado de Reproducci√≥n */
    .player-view {
      display: none;
      width: 100%;
      box-sizing: border-box;
    }

    .player-view.active {
      display: block;
      width: 100%;
      box-sizing: border-box;
    }

    /* Animaci√≥n del sobre */
    .envelope-animation-container {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 5000;
      background: linear-gradient(135deg, #fce4ec 0%, #ffe0e6 100%);
      /* Permitir scroll (especialmente en m√≥vil) */
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      min-height: 100vh;
      perspective: 1000px;
    }

    .envelope-animation-container.active {
      display: flex;
    }

    .envelope-animation {
      background: #d97777;
      border-radius: 0 0 4px 4px;
      width: 320px;
      height: 320px;
      min-height: 320px;
      margin: 20px auto;
      position: relative;
      transition: all 0.3s cubic-bezier(0.42, 0, 0.58, 1);
      transform-origin: 50% 50%;
      cursor: pointer;
    }

    .envelope-animation::before,
    .envelope-animation::after {
      content: '';
      display: block;
      position: absolute;
      bottom: 0;
      z-index: 2;
    }

    .envelope-animation::before {
      left: 0;
      width: 0;
      height: 0;
      border-style: solid;
      border-width: 296px 0 0 300px;
      border-color: transparent transparent transparent #E9978C;
    }

    .envelope-animation::after {
      right: 0;
      width: 0;
      height: 0;
      border-style: solid;
      border-width: 0 0 296px 300px;
      border-color: transparent transparent #E9978C transparent;
    }

    .envelope-animation.open {
      transform: rotateZ(7deg) translateY(130px) rotateY(-9deg);
    }

    .envelope-animation.open .flap-outside-animation {
      top: -1px;
      animation: open-flap-animation 0.6s ease-in-out forwards;
    }

    .envelope-animation.open .flap-outside-animation .flap-animation {
      background: #d97777;
    }

    .envelope-animation.open .card-animation {
      transform: translateX(14%) translateY(-200px);
      transition-delay: 0.6s;
    }

    .card-animation {
      background: #ffffff;
      position: absolute;
      font-size: 1.4rem;
      overflow: hidden;
      left: 0;
      bottom: 0;
      width: 70%;
      height: 85%;
      padding: 10px 20px;
      transform: translateX(14%);
      transition: all 0.3s cubic-bezier(0.42, 0, 0.58, 1) 0s;
      z-index: 1;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .card-content-animation {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 10px;
      overflow-y: auto;
    }

    .card-image-animation {
      width: 100%;
      max-height: 150px;
      min-height: 100px;
      object-fit: cover;
      border-radius: 6px;
      margin-bottom: 10px;
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
    }

    #cardImageContainerAnimation {
      width: 100%;
      margin-bottom: 10px;
      display: block !important;
      visibility: visible !important;
    }

    .card-text-animation {
      font-size: 0.9rem;
      color: #2f2f2f;
      line-height: 1.4;
      text-align: center;
    }

    .card-title-animation {
      font-size: 1.1rem;
      font-weight: 700;
      margin-bottom: 8px;
      color: #d97777;
    }

    .flap-container-animation {
      border-radius: 4px;
      overflow: hidden;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      transition: all 0.4s cubic-bezier(0.18, 0.81, 0.76, 0.93) 0s;
      z-index: 3;
    }

    .flap-outside-animation {
      overflow-y: auto;
      transform-origin: 50% 0;
      animation-delay: 0.6s;
      animation-fill-mode: backwards;
      z-index: 4;
    }

    .flap-outside-animation .flap-animation {
      background: #E9978C;
      backface-visibility: hidden;
    }

    .flap-outside-animation .flap-animation::after {
      background: #d97777;
      backface-visibility: hidden;
      content: '';
      display: block;
      position: absolute;
      transform: rotateX(180deg);
      height: 100%;
      width: 100%;
      left: 0;
      top: 0;
      z-index: 1;
    }

    .flap-inside-animation {
      transform: rotateX(180deg);
      border-radius: 0 0 4px 4px;
      overflow: hidden;
    }

    .flap-inside-animation .flap-animation {
      border-radius: 40px 40px 80px 40px;
      border: 1px solid #d97777;
      margin-top: 20px;
    }

    .flap-animation {
      background: #E9978C;
      border: 1px solid #d97777;
      border-radius: 40px;
      overflow: hidden;
      width: 300px;
      height: 300px;
      position: absolute;
      top: -50%;
      left: 50%;
      margin: -20px 0 0 -151px;
      transform: rotateZ(45deg);
      transform-style: preserve-3d;
      transition: all 0.8s ease 0s;
      z-index: 2;
    }

    .flap-animation .lining {
      background: linear-gradient(135deg, #A3CAC0 0%, #8BB5AB 100%);
      backface-visibility: hidden;
      border-radius: 0 0 40px 0;
      position: absolute;
      top: 0;
      left: 0;
      width: 92%;
      height: 92%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
    }

    .instruction-text-animation {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 1.8rem;
      color: #2f2f2f;
      font-weight: 700;
      z-index: 100;
      text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.8);
    }

    @keyframes open-flap-animation {
      0% {
        transform: rotateX(0deg);
        z-index: 4;
      }
      50% {
        transform: rotateX(90deg);
        z-index: 0;
      }
      100% {
        transform: rotateX(180deg);
        z-index: 0;
      }
    }

    @media (max-width: 768px) {
      .envelope-animation {
        width: 280px;
        height: 280px;
        min-height: 280px;
      }

      .flap-animation {
        width: 260px;
        height: 260px;
        margin: -20px 0 0 -131px;
      }

      .instruction-text-animation {
        font-size: 1.4rem;
        top: 10px;
      }
    }

    .player-container {
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1), 
                  0 0 0 1px rgba(0, 0, 0, 0.05),
                  inset 0 1px 0 rgba(255, 255, 255, 0.9);
      padding: 50px 40px;
      margin: 30px auto;
      max-width: 800px;
      text-align: center;
      position: relative;
      z-index: 10;
      /* Efecto de papel/carta */
      background-image: 
        linear-gradient(90deg, rgba(0,0,0,0.02) 1px, transparent 1px),
        linear-gradient(rgba(0,0,0,0.02) 1px, transparent 1px);
      background-size: 20px 20px;
      border: 1px solid rgba(0, 0, 0, 0.08);
    }
    
    /* Efecto de sombra de carta en el papel */
    .player-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(to bottom, rgba(255,255,255,0.1) 0%, transparent 50%);
      pointer-events: none;
      border-radius: 8px;
    }

    .player-container h1 {
      color: #333;
      font-size: 28px;
      margin-bottom: 15px;
      font-weight: 600;
      letter-spacing: -0.5px;
    }

    .player-container .description {
      color: #555;
      font-size: 17px;
      margin-bottom: 30px;
      line-height: 1.6;
      font-weight: 400;
    }

    .audio-player {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 30px;
      margin: 30px 0;
    }

    .play-button {
      background: linear-gradient(135deg, #ef4444 0%, #ec4899 100%);
      color: white;
      border: none;
      border-radius: 50%;
      width: 80px;
      height: 80px;
      font-size: 32px;
      cursor: pointer;
      margin: 20px auto;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .play-button:hover:not(:disabled) {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(239, 68, 68, 0.6);
    }

    .play-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .play-button.playing {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    audio {
      width: 100%;
      outline: none;
      margin-top: 15px;
    }

    .limits-info {
      margin-top: 15px;
      padding: 12px;
      background: #fff3cd;
      border-radius: 10px;
      font-size: 13px;
      color: #856404;
      border-left: 4px solid #ffc107;
    }

    .limits-info.expired {
      background: #f8d7da;
      color: #721c24;
      border-left-color: #dc3545;
    }

    .info {
      margin-top: 20px;
      padding: 15px;
      background: #e9ecef;
      border-radius: 10px;
      font-size: 14px;
      color: #495057;
    }

    /* Emoticones y GIFs */
    .emoji-item {
      padding: 8px;
      text-align: center;
      font-size: 24px;
      cursor: pointer;
      border-radius: 8px;
      transition: background 0.2s;
      user-select: none;
    }

    .emoji-item:hover {
      background: #e5e7eb;
    }

    .gif-item {
      position: relative;
      cursor: pointer;
      border-radius: 8px;
      overflow: hidden;
      border: 2px solid transparent;
      transition: all 0.2s;
    }

    .gif-item:hover {
      border-color: #ef4444;
      transform: scale(1.05);
    }

    .gif-item img {
      width: 100%;
      height: auto;
      display: block;
    }

    .gif-item.selected {
      border-color: #10b981;
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
    }

    /* ============================================ */
    /* ESTILOS PARA M√ìVILES (Optimizado para celular) */
    /* ============================================ */
    @media (max-width: 768px) {
      body {
        padding: 10px;
        min-height: 100vh;
      }

      .container {
        padding: 0 10px;
        max-width: 100%;
        width: 100%;
        box-sizing: border-box;
      }

      .header {
        padding: 50px 15px 30px;
        margin-bottom: 15px;
        border-radius: 0;
      }

      .header h1 {
        font-size: 16px;
        line-height: 1.4;
        padding: 0 10px;
        word-wrap: break-word;
      }

      .back-button {
        top: 10px;
        left: 10px;
        padding: 8px 12px;
        font-size: 14px;
        z-index: 200;
      }

      /* Carta optimizada para m√≥vil */
      .player-container {
        padding: 30px 20px;
        margin: 15px auto;
        max-width: 100%;
        width: calc(100% - 20px);
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1), 
                    0 0 0 1px rgba(0, 0, 0, 0.05);
        background-size: 15px 15px; /* L√≠neas m√°s peque√±as en m√≥vil */
        box-sizing: border-box;
      }

      .player-container h1 {
        font-size: 22px;
        margin-bottom: 12px;
        line-height: 1.4;
        word-wrap: break-word;
      }

      .player-container .description {
        font-size: 15px;
        margin-bottom: 25px;
        line-height: 1.6;
        padding: 0 5px;
        word-wrap: break-word;
      }

      /* Imagen optimizada para m√≥vil */
      #displayImage {
        margin: 20px 0 !important;
        width: 100%;
        box-sizing: border-box;
      }

      #displayImageImg {
        max-height: 350px !important;
        border-radius: 8px !important;
        width: 100% !important;
        height: auto !important;
        object-fit: contain !important;
      }

      /* Audio player optimizado */
      .audio-player {
        padding: 20px 15px;
        margin: 20px 0;
        border-radius: 12px;
        width: 100%;
        box-sizing: border-box;
      }

      .play-button {
        width: 70px;
        height: 70px;
        font-size: 28px;
        margin: 15px auto;
      }

      audio {
        margin-top: 12px;
        width: 100%;
        max-width: 100%;
      }

      /* L√≠mites de informaci√≥n */
      .limits-info {
        padding: 10px 12px;
        font-size: 12px;
        margin-top: 12px;
        border-radius: 8px;
        line-height: 1.5;
        word-wrap: break-word;
      }

      /* Informaci√≥n adicional */
      .info {
        padding: 15px;
        font-size: 13px;
        margin: 20px 0;
        word-wrap: break-word;
      }

      /* Footer optimizado */
      footer {
        margin: 30px auto 40px;
        padding: 0 15px;
        max-width: 100%;
      }

      footer > div {
        padding: 15px;
        font-size: 11px;
        line-height: 1.6;
        word-wrap: break-word;
      }

      /* Video container */
      #displayVideo {
        margin: 20px 0 !important;
        width: 100%;
        box-sizing: border-box;
      }

      #displayVideoContainer {
        max-width: 100% !important;
        width: 100% !important;
        border-radius: 12px !important;
        box-sizing: border-box;
      }

      #displayVideoContainer iframe {
        width: 100% !important;
        max-width: 100% !important;
        height: auto !important;
        min-height: 200px;
      }

      /* Animaci√≥n del sobre en m√≥vil */
      .envelope-animation {
        width: 280px;
        height: 280px;
        min-height: 280px;
      }

      .instruction-text-animation {
        font-size: 1.2rem;
        top: 10px;
      }
    }

    @media (max-width: 480px) {
      /* Pantallas muy peque√±as */
      body {
        padding: 5px;
      }

      .header {
        padding: 45px 12px 25px;
        margin-bottom: 10px;
      }

      .header h1 {
        font-size: 14px;
        padding: 0 5px;
        line-height: 1.3;
      }

      .back-button {
        top: 8px;
        left: 8px;
        padding: 6px 10px;
        font-size: 13px;
      }

      .player-container {
        padding: 25px 15px;
        margin: 10px auto;
        border-radius: 10px;
        width: calc(100% - 10px);
      }

      .player-container h1 {
        font-size: 20px;
        margin-bottom: 10px;
        line-height: 1.3;
      }

      .player-container .description {
        font-size: 14px;
        margin-bottom: 20px;
        padding: 0;
        line-height: 1.5;
      }

      #displayImage {
        margin: 15px 0 !important;
      }

      #displayImageImg {
        max-height: 280px !important;
        border-radius: 6px !important;
      }

      .audio-player {
        padding: 15px 12px;
        margin: 15px 0;
      }

      .play-button {
        width: 65px;
        height: 65px;
        font-size: 26px;
        margin: 12px auto;
      }

      .limits-info {
        padding: 8px 10px;
        font-size: 11px;
        line-height: 1.4;
      }

      .info {
        padding: 12px;
        font-size: 12px;
        line-height: 1.5;
      }

      footer {
        margin: 25px auto 30px;
        padding: 0 10px;
      }

      footer > div {
        padding: 12px;
        font-size: 10px;
        line-height: 1.5;
      }

      /* Animaci√≥n del sobre en pantallas muy peque√±as */
      .envelope-animation {
        width: 250px;
        height: 250px;
        min-height: 250px;
      }

      .instruction-text-animation {
        font-size: 1rem;
      }
    }

    /* Orientaci√≥n horizontal en m√≥vil */
    @media (max-width: 768px) and (orientation: landscape) {
      .header {
        padding: 30px 15px 20px;
      }

      .header h1 {
        font-size: 14px;
      }

      .player-container {
        padding: 25px 20px;
        margin: 10px auto;
      }

      #displayImageImg {
        max-height: 250px !important;
      }

      .play-button {
        width: 60px;
        height: 60px;
        font-size: 24px;
      }

      .audio-player {
        padding: 15px;
        margin: 15px 0;
      }
    }
  </style>
</head>
<body>
  <!-- Bot√≥n Volver -->
  <a href="javascript:history.back()" class="back-button">
    ‚Üê Volver
  </a>

  <!-- Header con coraz√≥n -->
  <div class="header" id="mainHeader">
    <div class="heart-icon">‚ù§Ô∏è</div>
    <h1 id="headerTitle">Crea tu Tarjeta</h1>
  </div>

  <!-- Modal de T√©rminos y Condiciones -->
  <div id="termsModal" style="display: none; position: fixed; inset: 0; z-index: 1000; align-items: center; justify-content: center; padding: 20px; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px);">
    <div style="background: white; border-radius: 25px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto;">
      <div style="background: linear-gradient(135deg, #ec4899 0%, #ef4444 100%); padding: 24px; text-align: center; color: white; border-radius: 25px 25px 0 0;">
        <div style="font-size: 32px; margin-bottom: 8px;">üõ°Ô∏è</div>
        <h2 style="font-size: 24px; font-weight: 700; margin: 0;">T√©rminos y Condiciones</h2>
        <p style="font-size: 14px; opacity: 0.9; margin-top: 8px;">Debes aceptar para continuar</p>
      </div>

      <div style="padding: 24px; space-y: 16px;">
        <div style="background: #fef2f2; border-left: 4px solid #ef4444; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
          <div style="display: flex; align-items: start; gap: 12px;">
            <div style="font-size: 24px; flex-shrink: 0;">‚ö†Ô∏è</div>
            <div>
              <h3 style="font-weight: 700; color: #991b1b; margin-bottom: 8px; font-size: 16px;">Pol√≠tica Anti-Bullying y Anti-Acoso</h3>
              <p style="font-size: 14px; color: #7f1d1d; line-height: 1.5;">
                Estamos comprometidos a crear un ambiente seguro y respetuoso. No toleramos ning√∫n tipo de acoso, 
                intimidaci√≥n, discriminaci√≥n o comportamiento da√±ino.
              </p>
            </div>
          </div>
        </div>

        <div style="margin-bottom: 16px;">
          <h4 style="font-weight: 600; margin-bottom: 8px; color: #333; font-size: 15px;">Al crear una tarjeta, te comprometes a:</h4>
          <ul style="list-style: disc; list-style-position: inside; margin-left: 8px; space-y: 4px; font-size: 14px; color: #666; line-height: 1.6;">
            <li>No usar contenido ofensivo, discriminatorio o que promueva el acoso</li>
            <li>Respetar los derechos de propiedad intelectual</li>
            <li>No compartir informaci√≥n personal de terceros sin consentimiento</li>
            <li>No crear contenido falso o difamatorio</li>
            <li>Mantener un ambiente seguro y respetuoso</li>
          </ul>
        </div>

        <div style="background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 8px; padding: 12px; margin-bottom: 16px;">
          <p style="font-size: 13px; color: #1e40af; line-height: 1.5;">
            <strong>Consecuencias:</strong> El contenido que viole esta pol√≠tica ser√° eliminado inmediatamente 
            y puede resultar en la prohibici√≥n permanente de tu cuenta.
          </p>
        </div>

        <div style="margin-bottom: 20px;">
          <p style="font-weight: 600; margin-bottom: 8px; color: #333; font-size: 14px;">Al hacer clic en "Aceptar", confirmas que:</p>
          <ul style="list-style: disc; list-style-position: inside; margin-left: 8px; font-size: 12px; color: #666; line-height: 1.5;">
            <li>Has le√≠do y entendido los t√©rminos y condiciones</li>
            <li>Has le√≠do y entendido la pol√≠tica anti-bullying</li>
            <li>Aceptas cumplir con todas las pol√≠ticas</li>
            <li>Entiendes las consecuencias de violar estas pol√≠ticas</li>
          </ul>
        </div>

        <div style="display: flex; gap: 12px; margin-bottom: 16px;">
          <a
            href="/terminos"
            target="_blank"
            style="flex: 1; text-align: center; padding: 12px; border: 2px solid #d1d5db; border-radius: 10px; color: #374151; font-weight: 500; text-decoration: none; transition: all 0.2s; background: #f9fafb;"
            onmouseover="this.style.background='#f3f4f6'"
            onmouseout="this.style.background='#f9fafb'"
          >
            Ver T√©rminos Completos
          </a>
          <a
            href="/antibullying"
            target="_blank"
            style="flex: 1; text-align: center; padding: 12px; border: 2px solid #d1d5db; border-radius: 10px; color: #374151; font-weight: 500; text-decoration: none; transition: all 0.2s; background: #f9fafb;"
            onmouseover="this.style.background='#f3f4f6'"
            onmouseout="this.style.background='#f9fafb'"
          >
            Ver Pol√≠tica Anti-Bullying
          </a>
        </div>

        <div style="padding: 16px; background: #f9fafb; border-radius: 10px; margin-bottom: 16px; border-top: 1px solid #e5e7eb;">
          <label style="display: flex; align-items: center; gap: 12px; cursor: pointer; padding: 12px; background: white; border-radius: 8px; border: 2px solid #e5e7eb; transition: all 0.2s;" 
                 onmouseover="this.style.borderColor='#ec4899'; this.style.background='#fef2f2'"
                 onmouseout="this.style.borderColor='#e5e7eb'; this.style.background='white'">
            <input
              type="checkbox"
              id="isAdultCheckbox"
              style="width: 20px; height: 20px; cursor: pointer; accent-color: #ef4444;"
            />
            <span style="color: #374151; font-weight: 500; font-size: 15px;">
              Confirmo que soy mayor de edad (18 a√±os o m√°s)
            </span>
          </label>
        </div>

        <button
          id="acceptTermsBtn"
          style="width: 100%; padding: 18px; background: linear-gradient(135deg, #ec4899 0%, #ef4444 100%); color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: 700; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(236, 72, 153, 0.4); opacity: 0.5; cursor: not-allowed;"
          disabled
        >
          Acepto los T√©rminos y la Pol√≠tica Anti-Bullying
        </button>
      </div>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- BLOQUEADOR DE PIN (ESTADO PREVIO) -->
  <!-- ============================================ -->
  <!-- Este bloqueador se muestra ANTES de los estados 1 y 2 -->
  <!-- Solo se muestra si la tarjeta tiene PIN (hasPin === true) -->
  <!-- Bloquea el acceso hasta que se ingrese el PIN correcto -->
  <!-- Una vez desbloqueado, se muestra el estado correspondiente: -->
  <!-- - Estado 1 (Personalizaci√≥n) si isPersonalized === false -->
  <!-- - Estado 2 (Mostrar Tarjeta) si isPersonalized === true -->
  <!-- ============================================ -->
  <div id="pinLockContainer" style="display: none; position: fixed; inset: 0; z-index: 2000; background: linear-gradient(135deg, #fce4ec 0%, #ffe0e6 100%); display: flex; align-items: center; justify-content: center; padding: 20px;">
    <div style="background: white; border-radius: 25px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); padding: 40px; max-width: 400px; width: 100%; text-align: center;">
      <div style="margin-bottom: 24px;">
        <div style="background: #fef2f2; border-radius: 50%; width: 80px; height: 80px; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
          <span style="font-size: 40px;">üîí</span>
        </div>
        <h2 style="font-size: 24px; font-weight: 700; color: #1f2937; margin-bottom: 8px;">Tarjeta Protegida</h2>
        <p style="color: #6b7280; font-size: 14px;">Ingresa el c√≥digo PIN de 4 d√≠gitos para ver esta tarjeta</p>
      </div>

      <div style="margin-bottom: 24px;">
        <div style="display: flex; justify-content: center; gap: 12px; margin-bottom: 16px;">
          <input type="text" id="pinInput0" maxlength="1" inputmode="numeric" style="width: 60px; height: 60px; text-align: center; font-size: 24px; font-weight: 700; border: 2px solid #d1d5db; border-radius: 12px; background: #f9fafb; font-family: monospace;" />
          <input type="text" id="pinInput1" maxlength="1" inputmode="numeric" style="width: 60px; height: 60px; text-align: center; font-size: 24px; font-weight: 700; border: 2px solid #d1d5db; border-radius: 12px; background: #f9fafb; font-family: monospace;" />
          <input type="text" id="pinInput2" maxlength="1" inputmode="numeric" style="width: 60px; height: 60px; text-align: center; font-size: 24px; font-weight: 700; border: 2px solid #d1d5db; border-radius: 12px; background: #f9fafb; font-family: monospace;" />
          <input type="text" id="pinInput3" maxlength="1" inputmode="numeric" style="width: 60px; height: 60px; text-align: center; font-size: 24px; font-weight: 700; border: 2px solid #d1d5db; border-radius: 12px; background: #f9fafb; font-family: monospace;" />
        </div>
        <div id="pinError" style="display: none; background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 12px; margin-top: 12px;">
          <p style="color: #991b1b; font-size: 14px; font-weight: 600; margin: 0;">C√≥digo incorrecto. Intenta de nuevo.</p>
        </div>
      </div>

      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 12px;">
        <button type="button" class="pin-num-btn" data-num="1" style="padding: 16px; background: #f3f4f6; border: none; border-radius: 12px; font-size: 20px; font-weight: 700; cursor: pointer; transition: all 0.2s;">1</button>
        <button type="button" class="pin-num-btn" data-num="2" style="padding: 16px; background: #f3f4f6; border: none; border-radius: 12px; font-size: 20px; font-weight: 700; cursor: pointer; transition: all 0.2s;">2</button>
        <button type="button" class="pin-num-btn" data-num="3" style="padding: 16px; background: #f3f4f6; border: none; border-radius: 12px; font-size: 20px; font-weight: 700; cursor: pointer; transition: all 0.2s;">3</button>
        <button type="button" class="pin-num-btn" data-num="4" style="padding: 16px; background: #f3f4f6; border: none; border-radius: 12px; font-size: 20px; font-weight: 700; cursor: pointer; transition: all 0.2s;">4</button>
        <button type="button" class="pin-num-btn" data-num="5" style="padding: 16px; background: #f3f4f6; border: none; border-radius: 12px; font-size: 20px; font-weight: 700; cursor: pointer; transition: all 0.2s;">5</button>
        <button type="button" class="pin-num-btn" data-num="6" style="padding: 16px; background: #f3f4f6; border: none; border-radius: 12px; font-size: 20px; font-weight: 700; cursor: pointer; transition: all 0.2s;">6</button>
        <button type="button" class="pin-num-btn" data-num="7" style="padding: 16px; background: #f3f4f6; border: none; border-radius: 12px; font-size: 20px; font-weight: 700; cursor: pointer; transition: all 0.2s;">7</button>
        <button type="button" class="pin-num-btn" data-num="8" style="padding: 16px; background: #f3f4f6; border: none; border-radius: 12px; font-size: 20px; font-weight: 700; cursor: pointer; transition: all 0.2s;">8</button>
        <button type="button" class="pin-num-btn" data-num="9" style="padding: 16px; background: #f3f4f6; border: none; border-radius: 12px; font-size: 20px; font-weight: 700; cursor: pointer; transition: all 0.2s;">9</button>
        <button type="button" id="pinClearBtn" style="padding: 16px; background: #fee2e2; border: none; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; color: #991b1b; transition: all 0.2s;">C</button>
        <button type="button" class="pin-num-btn" data-num="0" style="padding: 16px; background: #f3f4f6; border: none; border-radius: 12px; font-size: 20px; font-weight: 700; cursor: pointer; transition: all 0.2s;">0</button>
        <button type="button" id="pinBackBtn" style="padding: 16px; background: #fee2e2; border: none; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; color: #991b1b; transition: all 0.2s;">‚Üê</button>
      </div>
    </div>
  </div>
  <!-- ============================================ -->
  <!-- FIN BLOQUEADOR DE PIN -->
  <!-- ============================================ -->

  <div class="container" id="mainContainer">
    <!-- ============================================ -->
    <!-- ESTADO 1: PERSONALIZACI√ìN DE LA TARJETA -->
    <!-- ============================================ -->
    <!-- Este estado se muestra cuando isPersonalized === false -->
    <!-- Permite al usuario personalizar la tarjeta con: -->
    <!-- - Nombre del remitente y destinatario -->
    <!-- - Mensaje escrito -->
    <!-- - Imagen (c√°mara, subir archivo, o Nano Banana IA) -->
    <!-- - URL de video (Facebook, Instagram, TikTok) -->
    <!-- - Mensaje de voz (grabaci√≥n) -->
    <!-- - PIN de privacidad (opcional) -->
    <!-- ============================================ -->
    <div class="personalization-form" id="personalizationForm">
      <div class="form-container">
        <form id="personalizeForm">
          <div class="form-group">
            <label for="senderName">Tu nombre</label>
            <input 
              type="text" 
              id="senderName" 
              name="senderName" 
              placeholder="¬øQui√©n env√≠a esta tarjeta?" 
              value="{{SENDER_NAME}}"
              required
            >
          </div>

          <div class="form-group">
            <label for="recipientName">Para</label>
            <input 
              type="text" 
              id="recipientName" 
              name="recipientName" 
              placeholder="¬øA qui√©n va dirigida?" 
              value="{{RECIPIENT_NAME}}"
              required
            >
          </div>

          <div class="form-group">
            <label for="writtenMessage">Mensaje escrito</label>
            <div style="position: relative;">
              <textarea 
                id="writtenMessage" 
                name="writtenMessage" 
                placeholder="Escribe tu mensaje de amor..." 
                required
                style="padding-right: 50px;"
              >{{WRITTEN_MESSAGE}}</textarea>
              <button 
                type="button" 
                id="emojiButton"
                style="position: absolute; right: 10px; top: 10px; background: #f3f4f6; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 20px;"
                title="Agregar emoticones"
              >
                üòä
              </button>
            </div>
            
            <!-- Selector de emoticones -->
            <div id="emojiPicker" style="display: none; margin-top: 10px; padding: 15px; background: #f9fafb; border-radius: 12px; border: 2px solid #e5e7eb;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <span style="font-weight: 600; font-size: 14px;">Emoticones</span>
                <button 
                  type="button" 
                  id="closeEmojiPicker"
                  style="background: #dc2626; color: white; border: none; padding: 4px 8px; border-radius: 6px; cursor: pointer; font-size: 12px;"
                >
                  ‚úï
                </button>
              </div>
              <div id="emojiGrid" style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 8px; max-height: 200px; overflow-y: auto;">
                <!-- Emoticones se cargar√°n aqu√≠ -->
              </div>
            </div>

            <!-- Selector de Imagen -->
            <div style="margin-top: 10px;">
              <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: #333;">
                Foto (Opcional)
              </label>
              
              <!-- Preview de imagen seleccionada -->
              <div id="imagePreviewContainer" style="display: none; margin-bottom: 10px;">
                <div style="position: relative; display: inline-block;">
                  <img id="imagePreview" style="max-width: 100%; max-height: 300px; border-radius: 10px; border: 2px solid #e5e7eb;">
                  <button 
                    type="button" 
                    id="removeImage"
                    style="position: absolute; top: 10px; right: 10px; background: #dc2626; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;"
                  >
                    ‚úï Eliminar
                  </button>
                </div>
              </div>

              <!-- Opciones de imagen (solo si no hay preview) -->
              <div id="imageOptionsContainer" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                <!-- Tomar Foto -->
                <button 
                  type="button" 
                  id="openCameraButton"
                  style="padding: 16px; background: #dbeafe; border: 2px dashed #3b82f6; border-radius: 10px; cursor: pointer; text-align: center; transition: all 0.2s;"
                  onmouseover="this.style.background='#bfdbfe'; this.style.borderColor='#2563eb';"
                  onmouseout="this.style.background='#dbeafe'; this.style.borderColor='#3b82f6';"
                >
                  <div style="font-size: 24px; margin-bottom: 4px;">üì∑</div>
                  <div style="font-size: 12px; font-weight: 600; color: #1e40af;">Tomar Foto</div>
                  <div style="font-size: 10px; color: #64748b; margin-top: 2px;">Abrir c√°mara</div>
                </button>

                <!-- Subir Archivo -->
                <div style="padding: 16px; background: #f3f4f6; border: 2px dashed #9ca3af; border-radius: 10px; text-align: center; cursor: pointer; transition: all 0.2s;"
                  onmouseover="this.style.background='#e5e7eb'; this.style.borderColor='#6b7280';"
                  onmouseout="this.style.background='#f3f4f6'; this.style.borderColor='#9ca3af';"
                >
                  <input 
                    type="file" 
                    id="imageUpload" 
                    name="image"
                    accept="image/*"
                    style="display: none;"
                  >
                  <label for="imageUpload" style="cursor: pointer; display: block;">
                    <div style="font-size: 24px; margin-bottom: 4px;">üñºÔ∏è</div>
                    <div style="font-size: 12px; font-weight: 600; color: #374151;">Subir Archivo</div>
                    <div style="font-size: 10px; color: #64748b; margin-top: 2px;">JPG, PNG, GIF</div>
                  </label>
                </div>

                <!-- Generar con Nano Banana (IA) -->
                <button 
                  type="button" 
                  id="openNanoBananaButton"
                  style="padding: 16px; background: linear-gradient(135deg, #ff6b9d 0%, #c44569 100%); border: 2px dashed #ff6b9d; border-radius: 10px; cursor: pointer; text-align: center; transition: all 0.2s;"
                  onmouseover="this.style.background='linear-gradient(135deg, #ff8fb3 0%, #d65a7f 100%)'; this.style.borderColor='#ff8fb3';"
                  onmouseout="this.style.background='linear-gradient(135deg, #ff6b9d 0%, #c44569 100%)'; this.style.borderColor='#ff6b9d';"
                >
                  <div style="font-size: 24px; margin-bottom: 4px;">üçå‚ú®</div>
                  <div style="font-size: 12px; font-weight: 600; color: white;">Generar con IA</div>
                  <div style="font-size: 10px; color: rgba(255,255,255,0.9); margin-top: 2px;">Nano Banana</div>
                </button>
              </div>

              <!-- Ideas de Nano Banana (oculto inicialmente) -->
              <div id="nanoBananaContainer" style="display: none; margin-top: 12px; padding: 16px; background: linear-gradient(135deg, #fff0f5 0%, #ffe0e6 100%); border: 2px solid #ff6b9d; border-radius: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                  <h3 id="nanoBananaTitle" style="font-size: 16px; font-weight: 700; color: #c44569; margin: 0;">Genera tu imagen con IA:</h3>
                  <button
                    type="button"
                    id="closeNanoBananaButton"
                    style="padding: 8px 12px; background: #dc2626; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;"
                  >
                    ‚úï
                  </button>
                </div>

                <!-- Ocasi√≥n -->
                <div style="margin-bottom: 12px; display: grid; grid-template-columns: 1fr; gap: 6px;">
                  <label id="nanoBananaOccasionLabel" style="display: block; font-size: 12px; font-weight: 700; color: #c44569;">
                    Ocasi√≥n
                  </label>
                  <select id="nanoBananaOccasionSelect" style="width: 100%; padding: 10px; border: 2px solid #ffb3d1; border-radius: 10px; font-size: 13px; background: white;">
                    <option value="valentine">San Valent√≠n</option>
                    <option value="mothers-day">D√≠a de la Madre</option>
                    <option value="fathers-day">D√≠a del Padre</option>
                    <option value="birthday">Cumplea√±os</option>
                  </select>
                </div>
                
                <!-- Campo de texto personalizado -->
                <div style="margin-bottom: 16px; padding: 12px; background: white; border-radius: 8px; border: 2px solid #ff6b9d;">
                  <label style="display: block; font-size: 13px; font-weight: 600; color: #c44569; margin-bottom: 8px;">
                    ‚ú® Personaliza tu imagen (opcional):
                  </label>
                  <textarea
                    id="nanoBananaCustomPrompt"
                    placeholder='Ejemplo: "un capibara con un globo de corazon en xochimilco"'
                    style="width: 100%; min-height: 60px; padding: 10px; border: 2px solid #ffb3d1; border-radius: 8px; font-size: 13px; resize: vertical; font-family: inherit;"
                  ></textarea>
                  <div style="margin-top: 8px; font-size: 11px; color: #888; line-height: 1.4;">
                    <strong>Ejemplos:</strong><br>
                    ‚Ä¢ "un capibara con un globo de corazon en xochimilco"<br>
                    ‚Ä¢ "Una trajinera con el nombre Sarita te amo y un mariachi"<br>
                    ‚Ä¢ "Un gato tatuandose Valentina"
                  </div>
                  <button
                    type="button"
                    id="generateCustomPromptButton"
                    style="margin-top: 10px; width: 100%; padding: 10px; background: linear-gradient(135deg, #ff6b9d 0%, #c44569 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s;"
                    onmouseover="this.style.transform='scale(1.02)'"
                    onmouseout="this.style.transform='scale(1)'"
                  >
                    üé® Generar con mi texto
                  </button>
                </div>
                
                <div id="nanoBananaPresetLabel" style="text-align: center; margin: 12px 0; color: #c44569; font-size: 12px; font-weight: 600;">
                  O elige una idea predefinida:
                </div>
                
                <div id="nanoBananaIdeasGrid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; max-height: 300px; overflow-y: auto;">
                  <!-- Las 14 ideas se cargar√°n aqu√≠ -->
                </div>
                <div id="nanoBananaLoading" style="display: none; text-align: center; padding: 20px; color: #c44569; font-weight: 600;">
                  üé® Generando imagen con IA...
                </div>
              </div>

              <!-- Opci√≥n para usar como wallpaper -->
              <div id="wallpaperOptionContainer" style="display: none; margin-top: 12px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input 
                    type="checkbox" 
                    id="useImageAsWallpaperCheckbox"
                    style="width: 18px; height: 18px; cursor: pointer;"
                  >
                  <span style="font-size: 13px; color: #374151; font-weight: 500;">
                    Usar esta imagen como fondo de la tarjeta
                  </span>
                </label>
                <p style="font-size: 11px; color: #6b7280; margin-top: 4px; margin-left: 26px;">
                  La imagen se mostrar√° como wallpaper de fondo en lugar de dentro del contenido
                </p>
              </div>
            </div>
          </div>

          <!-- Campo de URL de Video -->
          <div class="form-group">
            <label for="videoUrl">URL de Video (Opcional)</label>
            <p style="font-size: 12px; color: #666; margin-bottom: 8px;">
              Comparte un video de Facebook, Instagram, TikTok o Twitter/X. Solo pega la URL del video.
            </p>
            <input 
              type="url" 
              id="videoUrl" 
              name="videoUrl" 
              placeholder="https://www.facebook.com/... o https://www.instagram.com/... o https://www.tiktok.com/... o https://twitter.com/..."
              style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;"
            >
            
            <!-- Preview del video -->
            <div id="videoPreviewContainer" style="display: none; margin-top: 12px; padding: 16px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 12px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <span style="font-weight: 600; font-size: 14px; color: #333;">Vista previa del video</span>
                <button 
                  type="button" 
                  id="removeVideo"
                  style="background: #dc2626; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;"
                >
                  ‚úï Eliminar
                </button>
              </div>
              <div id="videoPreview" style="width: 100%; min-height: 200px; background: #000; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white;">
                <p>Cargando preview...</p>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="voiceMessage">Mensaje de voz</label>
            <button 
              type="button" 
              class="record-button" 
              id="recordButton"
            >
              üé§ Grabar Mensaje
            </button>
            
            <!-- Vista previa de audio -->
            <div class="audio-preview" id="audioPreview" style="display: none;">
              <div class="audio-info">
                <span id="audioStatus">Audio grabado</span>
                <button 
                  type="button" 
                  id="deleteAudio"
                  style="background: #dc2626; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; margin-left: 10px;"
                >
                  Eliminar
                </button>
              </div>
              <audio id="previewAudio" controls style="width: 100%; margin-top: 10px;"></audio>
            </div>
          </div>

          <!-- Secci√≥n de PIN de Privacidad -->
          <div class="form-group" style="background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%); padding: 16px; border-radius: 12px; border: 2px solid #c084fc;">
            <div style="display: flex; align-items: start; gap: 12px; margin-bottom: 12px;">
              <div style="font-size: 24px;">üîí</div>
              <div style="flex: 1;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin-bottom: 8px;">
                  <input
                    type="checkbox"
                    id="enablePinCheckbox"
                    style="width: 20px; height: 20px; cursor: pointer;"
                  >
                  <span style="font-weight: 600; color: #6b21a8; font-size: 15px;">
                    Agregar PIN de privacidad (opcional)
                  </span>
                </label>
                <p style="font-size: 13px; color: #6b7280; margin-left: 28px; line-height: 1.5;">
                  Protege tu tarjeta con un c√≥digo de 4 d√≠gitos. Solo quien tenga el c√≥digo podr√° verla.
                </p>
              </div>
            </div>

            <!-- Campo de PIN (oculto inicialmente) -->
            <div id="pinInputContainer" style="display: none; margin-top: 12px; margin-left: 36px;">
              <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: #6b21a8;">
                C√≥digo PIN (4 d√≠gitos) *
              </label>
              <input
                type="text"
                id="pinInput"
                inputmode="numeric"
                maxlength="4"
                placeholder="1234"
                style="width: 100%; max-width: 200px; padding: 12px; border: 2px solid #c084fc; border-radius: 8px; text-align: center; font-size: 20px; font-weight: 700; font-family: monospace; letter-spacing: 4px;"
              >
              <p style="font-size: 11px; color: #6b7280; margin-top: 6px;">
                Comparte este c√≥digo solo con quien quieras que vea la tarjeta
              </p>
            </div>
          </div>
            
          </div>

          <button type="submit" class="submit-button" id="submitBtn">
            Crear Tarjeta
          </button>
        </form>

        <div class="status-message" id="statusMessage"></div>
      </div>
    </div>
    <!-- ============================================ -->
    <!-- FIN ESTADO 1: PERSONALIZACI√ìN -->
    <!-- ============================================ -->

    <!-- ============================================ -->
    <!-- ESTADO 2: MOSTRAR LA TARJETA PERSONALIZADA -->
    <!-- ============================================ -->
    <!-- Este estado se muestra cuando isPersonalized === true -->
    <!-- Muestra la tarjeta completa con: -->
    <!-- - T√≠tulo y descripci√≥n personalizados -->
    <!-- - Imagen personalizada (si existe) -->
    <!-- - Video (si existe) -->
    <!-- - Reproductor de audio con el mensaje de voz -->
    <!-- - Informaci√≥n de l√≠mites de reproducci√≥n -->
    <!-- - Informaci√≥n del remitente y destinatario -->
    <!-- ============================================ -->
    
    <!-- Animaci√≥n del sobre (se muestra primero cuando la p√°gina est√° personalizada) -->
    <div class="envelope-animation-container" id="envelopeAnimationContainer">
      <p class="instruction-text-animation">Haz clic en el sobre para abrirlo</p>
      
      <div class="envelope-animation" id="envelopeAnimation">
        <div class="card-animation">
          <div class="card-content-animation">
            <div class="card-title-animation" id="cardTitleAnimation">üíå Tarjeta Especial</div>
            <div id="cardImageContainerAnimation" style="display: none; width: 100%; margin-bottom: 10px; visibility: visible;">
              <img id="cardImageAnimation" class="card-image-animation" src="" alt="Imagen de la tarjeta" style="width: 100%; max-height: 150px; min-height: 100px; object-fit: cover; border-radius: 6px; display: block; visibility: visible; opacity: 1;">
            </div>
            <div class="card-text-animation" id="cardMessageAnimation">
              {{WRITTEN_MESSAGE}}
            </div>
          </div>
        </div>
        
        <div class="flap-outside-animation flap-container-animation">
          <div class="flap-animation">
            <div class="lining">üíù</div>
          </div>
        </div>
        
        <div class="flap-inside-animation flap-container-animation">
          <div class="flap-animation"></div>
        </div>
      </div>
    </div>

    <div class="player-view" id="playerView">
      <div class="player-container">
        <h1>{{TITLE}}</h1>
        <p class="description">{{DESCRIPTION}}</p>
        
        <!-- Imagen (si existe) - Siempre se muestra dentro de la carta -->
        <div id="displayImage" style="margin: 30px 0; text-align: center; display: none; visibility: visible; opacity: 1;">
          <img id="displayImageImg" src="" alt="Foto personalizada" style="max-width: 100%; max-height: 500px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); object-fit: contain; display: block; visibility: visible; opacity: 1; border: 1px solid rgba(0,0,0,0.05); width: 100%; height: auto; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
        </div>
        
        <!-- Video (si existe) -->
        <div id="displayVideo" style="margin: 20px 0; text-align: center; display: none;">
          <div id="displayVideoContainer" style="width: 100%; max-width: 500px; margin: 0 auto; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1);"></div>
        </div>
        
        <div class="audio-player">
          <button class="play-button" id="playButton" aria-label="Reproducir audio">
            ‚ñ∂
          </button>
          <audio id="audioPlayer" controls preload="metadata">
            <source src="{{AUDIO_URL}}" type="audio/mpeg">
            Tu navegador no soporta el elemento de audio.
          </audio>
          <div id="status" style="margin-top: 15px; color: #666; font-size: 14px;">Cargando audio...</div>
        </div>

        <div class="limits-info" id="limitsInfo"></div>

        <div class="info">
          <p>Comparte esta p√°gina para que otros puedan escuchar el audio</p>
        </div>
      </div>
    </div>
    <!-- ============================================ -->
    <!-- FIN ESTADO 2: MOSTRAR LA TARJETA -->
    <!-- ============================================ -->

  </div>

  <!-- Footer con T√©rminos y Condiciones - Siempre visible -->
  <footer style="position: relative; z-index: 10; margin: 40px auto 60px; padding: 0 20px; max-width: 800px; width: 100%; display: block !important; visibility: visible !important;">
    <div style="padding: 20px; background: white !important; border-radius: 15px; text-align: center; border: 2px solid #e5e7eb; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15); opacity: 1 !important;">
      <p style="font-size: 12px; color: #333 !important; line-height: 1.6; margin-bottom: 8px; font-weight: 500;">
        Al usar este servicio, aceptas nuestros 
        <a href="/terminos" target="_blank" style="color: #ef4444; text-decoration: underline; font-weight: 600;">T√©rminos y Condiciones</a>
        y nuestra 
        <a href="/antibullying" target="_blank" style="color: #ef4444; text-decoration: underline; font-weight: 600;">Pol√≠tica Anti-Bullying</a>
      </p>
      <p style="font-size: 11px; color: #666 !important; margin-top: 8px;">
        Nos comprometemos a crear un ambiente seguro y respetuoso. El contenido ofensivo ser√° eliminado inmediatamente.
      </p>
    </div>
  </footer>

  <!-- Modal de Carga de Imagen IA -->
  <div id="nanoBananaLoadingModal" style="display: none; position: fixed; inset: 0; z-index: 10001; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); align-items: center; justify-content: center; padding: 20px;">
    <div style="background: white; border-radius: 20px; padding: 40px 30px; max-width: 400px; width: 90%; text-align: center; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);">
      <div style="font-size: 48px; margin-bottom: 20px; animation: spin 1s linear infinite;">üé®</div>
      <h2 style="color: #c44569; font-size: 24px; font-weight: 700; margin: 0 0 15px 0;">Espera tu imagen...</h2>
      <p style="color: #6b7280; font-size: 16px; margin: 0; line-height: 1.6;">
        Estamos generando tu imagen personalizada con IA.<br>
        <strong style="color: #c44569;">Puede tardar de 5 a 10 segundos</strong>
      </p>
      <div style="margin-top: 25px; display: flex; justify-content: center; gap: 8px;">
        <div style="width: 12px; height: 12px; background: #ff6b9d; border-radius: 50%; animation: pulse-dot 1.4s ease-in-out infinite;"></div>
        <div style="width: 12px; height: 12px; background: #ff6b9d; border-radius: 50%; animation: pulse-dot 1.4s ease-in-out infinite 0.2s;"></div>
        <div style="width: 12px; height: 12px; background: #ff6b9d; border-radius: 50%; animation: pulse-dot 1.4s ease-in-out infinite 0.4s;"></div>
      </div>
    </div>
  </div>

  <!-- Modal de Compartir Tarjeta -->
  <div id="shareModal" style="display: none; position: fixed; inset: 0; z-index: 10000; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); align-items: center; justify-content: center; padding: 20px;">
    <div style="background: white; border-radius: 25px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); padding: 40px; max-width: 500px; width: 100%; text-align: center; position: relative;">
      <button 
        id="closeShareModal"
        style="position: absolute; top: 15px; right: 15px; background: #f3f4f6; border: none; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; color: #666;"
      >
        ‚úï
      </button>
      
      <div style="margin-bottom: 24px;">
        <div style="background: linear-gradient(135deg, #ec4899 0%, #ef4444 100%); border-radius: 50%; width: 80px; height: 80px; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px; font-size: 40px;">
          üéâ
        </div>
        <h2 style="font-size: 28px; font-weight: 700; color: #1f2937; margin-bottom: 8px;">¬°Tarjeta Creada!</h2>
        <p id="shareModalMessage" style="color: #6b7280; font-size: 16px; margin: 0;">
          Comparte tu tarjeta con quien quieras
        </p>
      </div>

      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px;">
        <!-- Instagram -->
        <button 
          id="shareInstagram"
          style="padding: 16px; background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: transform 0.2s;"
          onmouseover="this.style.transform='scale(1.05)'"
          onmouseout="this.style.transform='scale(1)'"
        >
          <span style="font-size: 24px;">üì∑</span>
          <span>Instagram</span>
        </button>

        <!-- Facebook -->
        <button 
          id="shareFacebook"
          style="padding: 16px; background: #1877f2; color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: transform 0.2s;"
          onmouseover="this.style.transform='scale(1.05)'"
          onmouseout="this.style.transform='scale(1)'"
        >
          <span style="font-size: 24px;">üë§</span>
          <span>Facebook</span>
        </button>

        <!-- WhatsApp -->
        <button 
          id="shareWhatsApp"
          style="padding: 16px; background: #25d366; color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: transform 0.2s;"
          onmouseover="this.style.transform='scale(1.05)'"
          onmouseout="this.style.transform='scale(1)'"
        >
          <span style="font-size: 24px;">üí¨</span>
          <span>WhatsApp</span>
        </button>

        <!-- Twitter/X -->
        <button 
          id="shareTwitter"
          style="padding: 16px; background: #000000; color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: transform 0.2s;"
          onmouseover="this.style.transform='scale(1.05)'"
          onmouseout="this.style.transform='scale(1)'"
        >
          <span style="font-size: 24px;">ùïè</span>
          <span>Twitter</span>
        </button>

        <!-- Copiar URL -->
        <button 
          id="copyUrl"
          style="padding: 16px; background: linear-gradient(135deg, #ec4899 0%, #ef4444 100%); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: transform 0.2s;"
          onmouseover="this.style.transform='scale(1.05)'"
          onmouseout="this.style.transform='scale(1)'"
        >
          <span style="font-size: 24px;">üîó</span>
          <span>Copiar URL</span>
        </button>
      </div>

      <div id="copyUrlFeedback" style="display: none; padding: 12px; background: #d4edda; color: #155724; border-radius: 8px; margin-top: 12px; font-size: 14px; font-weight: 600;">
        ‚úì URL copiada al portapapeles
      </div>
    </div>
  </div>

  <script>
    // Datos de la p√°gina
    const PAGE_DATA = {
      code: '{{CODE}}',
      baseUrl: '{{BASE_URL}}',
      isPersonalized: '{{IS_PERSONALIZED}}' === 'true',
      playCount: parseInt('{{PLAY_COUNT}}') || 0,
      maxPlays: parseInt('{{MAX_PLAYS}}') || 5,
      expirationDate: '{{EXPIRATION_DATE}}' ? new Date('{{EXPIRATION_DATE}}') : null,
      imageUrl: '{{IMAGE_URL}}' || null,
      videoUrl: '{{VIDEO_URL}}' || null,
      hasPin: '{{HAS_PIN}}' === 'true',
      // NO enviar el PIN al cliente por seguridad
      isDemo: '{{CODE}}' === 'DEMO1234',
      useImageAsWallpaper: '{{USE_IMAGE_AS_WALLPAPER}}' === 'true',
      title: '{{JS_TITLE}}' || '',
      description: '{{JS_DESCRIPTION}}' || '',
      writtenMessage: '{{JS_WRITTEN_MESSAGE}}' || '',
      senderName: '{{JS_SENDER_NAME}}' || '',
      recipientName: '{{JS_RECIPIENT_NAME}}' || '',
    };

    // Aplicar imagen como wallpaper si est√° configurada (inicial)
    function applyWallpaperIfNeeded() {
      if (PAGE_DATA.useImageAsWallpaper && PAGE_DATA.imageUrl) {
        document.body.style.backgroundImage = `url('${PAGE_DATA.imageUrl}')`;
        document.body.style.backgroundSize = 'cover';
        document.body.style.backgroundPosition = 'center';
        document.body.style.backgroundAttachment = 'fixed';
        document.body.classList.add('has-wallpaper');
      }
    }
    
    // Aplicar al cargar la p√°gina
    applyWallpaperIfNeeded();

    const displayImage = document.getElementById('displayImage');
    const displayImageImg = document.getElementById('displayImageImg');

    // Hacer la imagen clickeable para abrir la URL de la tarjeta
    if (displayImageImg) {
      displayImageImg.addEventListener('click', () => {
        const cardUrl = `${PAGE_DATA.baseUrl}/page/${PAGE_DATA.code}`;
        window.open(cardUrl, '_blank');
      });
    }

    const personalizationForm = document.getElementById('personalizationForm');
    const playerView = document.getElementById('playerView');
    const personalizeForm = document.getElementById('personalizeForm');
    const recordButton = document.getElementById('recordButton');
    const audioPreview = document.getElementById('audioPreview');
    const previewAudio = document.getElementById('previewAudio');
    const deleteAudioBtn = document.getElementById('deleteAudio');
    const submitBtn = document.getElementById('submitBtn');
    const statusMessage = document.getElementById('statusMessage');
    const audio = document.getElementById('audioPlayer');
    const playButton = document.getElementById('playButton');
    const status = document.getElementById('status');
    const limitsInfo = document.getElementById('limitsInfo');
    const emojiButton = document.getElementById('emojiButton');
    const emojiPicker = document.getElementById('emojiPicker');
    const emojiGrid = document.getElementById('emojiGrid');
    const closeEmojiPicker = document.getElementById('closeEmojiPicker');
    const imageUpload = document.getElementById('imageUpload');
    const imageUploadButton = document.getElementById('imageUploadButton');
    const imagePreviewContainer = document.getElementById('imagePreviewContainer');
    const imagePreview = document.getElementById('imagePreview');
    const removeImage = document.getElementById('removeImage');
    const imageOptionsContainer = document.getElementById('imageOptionsContainer');
    const openCameraButton = document.getElementById('openCameraButton');
    const openNanoBananaButton = document.getElementById('openNanoBananaButton');
    const nanoBananaContainer = document.getElementById('nanoBananaContainer');
    const nanoBananaIdeasGrid = document.getElementById('nanoBananaIdeasGrid');
    const closeNanoBananaButton = document.getElementById('closeNanoBananaButton');
    const nanoBananaLoading = document.getElementById('nanoBananaLoading');
    const nanoBananaCustomPrompt = document.getElementById('nanoBananaCustomPrompt');
    const generateCustomPromptButton = document.getElementById('generateCustomPromptButton');
    const wallpaperOptionContainer = document.getElementById('wallpaperOptionContainer');
    const useImageAsWallpaperCheckbox = document.getElementById('useImageAsWallpaperCheckbox');
    const enablePinCheckbox = document.getElementById('enablePinCheckbox');
    const pinInputContainer = document.getElementById('pinInputContainer');
    const pinInput = document.getElementById('pinInput');
    
    let cameraStream = null;
    let videoElement = null;
    let canvasElement = null;
    const writtenMessage = document.getElementById('writtenMessage');
    const termsModal = document.getElementById('termsModal');
    const acceptTermsBtn = document.getElementById('acceptTermsBtn');
    const isAdultCheckbox = document.getElementById('isAdultCheckbox');
    const pinLockContainer = document.getElementById('pinLockContainer');
    const mainContainer = document.getElementById('mainContainer');
    let termsAccepted = false;
    let isAdult = false;
    let pinAttempts = 0;

    // Elementos del PIN
    const pinInputs = [
      document.getElementById('pinInput0'),
      document.getElementById('pinInput1'),
      document.getElementById('pinInput2'),
      document.getElementById('pinInput3'),
    ];
    const pinError = document.getElementById('pinError');
    const pinNumBtns = document.querySelectorAll('.pin-num-btn');
    const pinClearBtn = document.getElementById('pinClearBtn');
    const pinBackBtn = document.getElementById('pinBackBtn');

    // Manejar checkbox de mayor de edad
    isAdultCheckbox.addEventListener('change', (e) => {
      isAdult = e.target.checked;
      if (isAdult) {
        acceptTermsBtn.disabled = false;
        acceptTermsBtn.style.opacity = '1';
        acceptTermsBtn.style.cursor = 'pointer';
      } else {
        acceptTermsBtn.disabled = true;
        acceptTermsBtn.style.opacity = '0.5';
        acceptTermsBtn.style.cursor = 'not-allowed';
      }
    });

    // Manejar aceptaci√≥n de t√©rminos
    acceptTermsBtn.addEventListener('click', () => {
      if (!isAdult) {
        alert('Debes confirmar que eres mayor de edad para continuar');
        return;
      }
      termsAccepted = true;
      termsModal.style.display = 'none';
      submitBtn.disabled = false;
    });

    // Bloquear el bot√≥n de submit hasta aceptar t√©rminos
    submitBtn.disabled = true;

    let mediaRecorder = null;
    let audioChunks = [];
    let audioBlob = null;
    let recordingStream = null;
    let recordingStartTime = null;
    let recordingTimer = null;
    let selectedImageFile = null;

    // Manejar eliminaci√≥n de demo al cerrar ventana
    if (PAGE_DATA.isDemo) {
      let demoDeleted = false;
      
      function deleteDemo() {
        if (demoDeleted) return;
        demoDeleted = true;
        
        // Usar sendBeacon para asegurar que la petici√≥n se env√≠e incluso si la p√°gina se cierra
        const url = `${PAGE_DATA.baseUrl}/api/pages/demo`;
        if (navigator.sendBeacon) {
          // sendBeacon no soporta DELETE directamente, usar fetch con keepalive
          fetch(url, {
            method: 'DELETE',
            keepalive: true,
          }).catch(() => {
            // Ignorar errores si la p√°gina ya se cerr√≥
          });
        } else {
          // Fallback para navegadores que no soportan keepalive
          fetch(url, {
            method: 'DELETE',
          }).catch(() => {
            // Ignorar errores si la p√°gina ya se cerr√≥
          });
        }
      }
      
      // Detectar cierre de ventana/pesta√±a
      window.addEventListener('beforeunload', deleteDemo);
      window.addEventListener('unload', deleteDemo);
      
      // Detectar cuando la pesta√±a se oculta (puede indicar cierre)
      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'hidden') {
          // Esperar un poco para ver si vuelve a ser visible
          setTimeout(() => {
            if (document.visibilityState === 'hidden') {
              deleteDemo();
            }
          }, 2000);
        }
      });
      
      // Tambi√©n eliminar si se navega a otra p√°gina
      window.addEventListener('pagehide', deleteDemo);
    }

    // Emoticones populares para San Valent√≠n
    const popularEmojis = [
      '‚ù§Ô∏è', 'üíï', 'üíñ', 'üíó', 'üíì', 'üíû', 'üíù', 'üíò',
      'üòç', 'ü•∞', 'üòò', 'üòó', 'üòô', 'üòö', 'üòª', 'üíã',
      'üåπ', 'üå∑', 'üå∫', 'üå∏', 'üíê', 'üåª', 'üåº', 'üåø',
      'üíë', 'üë´', 'üë©‚Äç‚ù§Ô∏è‚Äçüë®', 'üë®‚Äç‚ù§Ô∏è‚Äçüë®', 'üë©‚Äç‚ù§Ô∏è‚Äçüë©', 'üíè', 'üíë', 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶',
      'üéÅ', 'üéÄ', 'üéÇ', 'üç∞', 'üç´', 'üç¨', 'üç≠', 'üç©',
      '‚ú®', '‚≠ê', 'üåü', 'üí´', 'üíé', 'üéà', 'üéâ', 'üéä',
      'üòä', 'üòÑ', 'üòÉ', 'üòÅ', 'üòÜ', 'üòÖ', 'ü§£', 'üòÇ',
      'ü•≥', 'ü§ó', 'ü§©', 'üòá', 'üòä', 'üôÇ', 'üòâ', 'üòå'
    ];

    // Cargar emoticones
    function loadEmojis() {
      emojiGrid.innerHTML = '';
      popularEmojis.forEach(emoji => {
        const emojiItem = document.createElement('div');
        emojiItem.className = 'emoji-item';
        emojiItem.textContent = emoji;
        emojiItem.addEventListener('click', () => {
          insertEmoji(emoji);
        });
        emojiGrid.appendChild(emojiItem);
      });
    }

    // Insertar emotic√≥n en el textarea
    function insertEmoji(emoji) {
      const textarea = writtenMessage;
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      const text = textarea.value;
      const newText = text.substring(0, start) + emoji + text.substring(end);
      textarea.value = newText;
      textarea.focus();
      textarea.setSelectionRange(start + emoji.length, start + emoji.length);
    }

    // Toggle selector de emoticones
    emojiButton.addEventListener('click', () => {
      if (emojiPicker.style.display === 'none') {
        emojiPicker.style.display = 'block';
        loadEmojis();
      } else {
        emojiPicker.style.display = 'none';
      }
    });

    closeEmojiPicker.addEventListener('click', () => {
      emojiPicker.style.display = 'none';
    });

    // Manejar selecci√≥n de imagen desde archivo
    if (imageUpload) {
      imageUpload.addEventListener('change', (e) => {
        const file = e.target.files && e.target.files[0];
        if (file) {
          handleImageFile(file);
        }
      });
    }

    // Manejar selecci√≥n de imagen desde archivo
    if (imageUpload) {
      imageUpload.addEventListener('change', (e) => {
        const file = e.target.files && e.target.files[0];
        if (file) {
          handleImageFile(file);
        }
      });
    }

    // Funci√≥n para manejar archivo de imagen
    function handleImageFile(file) {
      // Validar tipo de archivo
      if (!file.type.startsWith('image/')) {
        showStatus('Por favor selecciona un archivo de imagen v√°lido', 'error');
        return;
      }
      
      // Validar tama√±o (10MB m√°ximo)
      if (file.size > 10 * 1024 * 1024) {
        showStatus('La imagen no puede ser mayor a 10MB', 'error');
        return;
      }

      selectedImageFile = file;
      const reader = new FileReader();
      reader.onloadend = () => {
        imagePreview.src = reader.result;
        imagePreviewContainer.style.display = 'block';
        if (imageOptionsContainer) imageOptionsContainer.style.display = 'none';
        if (wallpaperOptionContainer) wallpaperOptionContainer.style.display = 'block';
      };
      reader.readAsDataURL(file);
    }

    // Abrir c√°mara
    if (openCameraButton) {
      openCameraButton.addEventListener('click', async () => {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: 'user' } 
          });
          cameraStream = stream;
          
          // Crear modal de c√°mara
          const cameraModal = document.createElement('div');
          cameraModal.id = 'cameraModal';
          cameraModal.style.cssText = 'position: fixed; inset: 0; z-index: 2000; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; padding: 20px;';
          
          cameraModal.innerHTML = `
            <div style="background: white; border-radius: 20px; padding: 24px; max-width: 600px; width: 100%;">
              <div style="display: flex; justify-between; align-items: center; margin-bottom: 16px;">
                <h3 style="font-size: 20px; font-weight: 700; color: #333;">Tomar Foto</h3>
                <button id="closeCameraBtn" style="background: #dc2626; color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer;">‚úï</button>
              </div>
              <div style="background: black; border-radius: 12px; overflow: hidden; margin-bottom: 16px;">
                <video id="cameraVideo" autoplay playsinline style="width: 100%; max-height: 400px;"></video>
                <canvas id="cameraCanvas" style="display: none;"></canvas>
              </div>
              <div style="display: flex; gap: 12px;">
                <button id="cancelCameraBtn" style="flex: 1; padding: 12px; background: #e5e7eb; color: #374151; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Cancelar</button>
                <button id="capturePhotoBtn" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">üì∑ Capturar Foto</button>
              </div>
            </div>
          `;
          
          document.body.appendChild(cameraModal);
          
          const cameraVideo = document.getElementById('cameraVideo');
          const cameraCanvas = document.getElementById('cameraCanvas');
          const closeCameraBtn = document.getElementById('closeCameraBtn');
          const cancelCameraBtn = document.getElementById('cancelCameraBtn');
          const capturePhotoBtn = document.getElementById('capturePhotoBtn');
          
          cameraVideo.srcObject = stream;
          
          const closeCamera = () => {
            if (cameraStream) {
              cameraStream.getTracks().forEach(track => track.stop());
              cameraStream = null;
            }
            document.body.removeChild(cameraModal);
          };
          
          closeCameraBtn.addEventListener('click', closeCamera);
          cancelCameraBtn.addEventListener('click', closeCamera);
          
          capturePhotoBtn.addEventListener('click', () => {
            const context = cameraCanvas.getContext('2d');
            cameraCanvas.width = cameraVideo.videoWidth;
            cameraCanvas.height = cameraVideo.videoHeight;
            context.drawImage(cameraVideo, 0, 0);
            
            cameraCanvas.toBlob((blob) => {
              if (blob) {
                const file = new File([blob], `camera-${Date.now()}.jpg`, { type: 'image/jpeg' });
                handleImageFile(file);
                closeCamera();
              }
            }, 'image/jpeg', 0.9);
          });
        } catch (error) {
          console.error('Error accessing camera:', error);
          let errorMessage = 'No se pudo acceder a la c√°mara.';
          if (error.name === 'NotAllowedError') {
            errorMessage = 'Permiso de c√°mara denegado. Por favor, permite el acceso a la c√°mara.';
          } else if (error.name === 'NotFoundError') {
            errorMessage = 'No se encontr√≥ ninguna c√°mara.';
          }
          alert(errorMessage);
        }
      });
    }

    // Modal de carga de imagen IA (definir ANTES de generateNanoBananaImage)
    // Obtener el elemento de forma lazy para asegurar que el DOM est√© listo
    function getNanoBananaLoadingModal() {
      return document.getElementById('nanoBananaLoadingModal');
    }
    
    function showNanoBananaLoadingModal() {
      const modal = getNanoBananaLoadingModal();
      if (modal) {
        modal.style.display = 'flex';
      }
    }
    
    function hideNanoBananaLoadingModal() {
      const modal = getNanoBananaLoadingModal();
      if (modal) {
        modal.style.display = 'none';
      }
    }

    // Funci√≥n para generar imagen con Nano Banana (definida antes de usarse)
    let nanoBananaOccasion = 'valentine';

    function getNanoBananaOccasionPrefix(occasion) {
      if (occasion === 'valentine') return 'San Valent√≠n';
      if (occasion === 'mothers-day') return 'D√≠a Madre';
      if (occasion === 'fathers-day') return 'D√≠a Padre';
      if (occasion === 'birthday') return 'Cumplea√±os';
      return '';
    }

    async function generateNanoBananaImage(prompt) {
      // Verificar si ya se us√≥ para ESTA tarjeta espec√≠fica (usando el c√≥digo √∫nico)
      const cardCode = PAGE_DATA.code;
      const storageKey = `nanoBananaUsed_${cardCode}`;
      const nanoBananaUsed = localStorage.getItem(storageKey);
      if (nanoBananaUsed === 'true') {
        hideNanoBananaLoadingModal(); // Asegurar que el modal se oculte
        alert('‚ö†Ô∏è La generaci√≥n de im√°genes con IA solo se puede usar 1 vez por tarjeta. Ya has usado esta funci√≥n para esta tarjeta.');
        return;
      }

      // Mostrar indicadores de carga
      if (nanoBananaLoading) nanoBananaLoading.style.display = 'block';
      if (nanoBananaIdeasGrid) nanoBananaIdeasGrid.style.display = 'none';
      if (nanoBananaCustomPrompt) nanoBananaCustomPrompt.disabled = true;
      if (generateCustomPromptButton) generateCustomPromptButton.disabled = true;
      
      // Mostrar modal de carga (si no se mostr√≥ ya)
      showNanoBananaLoadingModal();

      try {
        // Prefijo por ocasi√≥n (solo si el prompt no lo incluye ya)
        let finalPrompt = prompt.trim();
        const prefix = getNanoBananaOccasionPrefix(nanoBananaOccasion);
        if (prefix) {
          const p = finalPrompt.toLowerCase();
          const pref = prefix.toLowerCase();
          if (!p.startsWith(pref)) {
            finalPrompt = `${prefix} ${finalPrompt}`;
          }
        }

        const generateResponse = await fetch(`${PAGE_DATA.baseUrl}/api/nano-banana/generate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt: finalPrompt }),
        });

        if (!generateResponse.ok) throw new Error('Error al generar imagen');

        const generateData = await generateResponse.json();
        const imageUrl = generateData.data?.imageUrl;

        if (imageUrl) {
          // Marcar como usado en localStorage para ESTA tarjeta espec√≠fica
          const cardCode = PAGE_DATA.code;
          const storageKey = `nanoBananaUsed_${cardCode}`;
          localStorage.setItem(storageKey, 'true');

          // Crear un File desde la URL
          const imgResponse = await fetch(imageUrl);
          const blob = await imgResponse.blob();
          const file = new File([blob], 'nano-banana-image.jpg', { type: 'image/jpeg' });

          handleImageFile(file);
          if (nanoBananaContainer) nanoBananaContainer.style.display = 'none';
          
          // Ocultar modal de carga
          hideNanoBananaLoadingModal();
        } else {
          throw new Error('No se recibi√≥ URL de imagen');
        }
      } catch (error) {
        console.error('Error generating image:', error);
        
        // Ocultar modal de carga
        hideNanoBananaLoadingModal();
        
        alert('Error al generar imagen. Intenta de nuevo.');
        if (nanoBananaLoading) nanoBananaLoading.style.display = 'none';
        if (nanoBananaIdeasGrid) nanoBananaIdeasGrid.style.display = 'grid';
        if (nanoBananaCustomPrompt) nanoBananaCustomPrompt.disabled = false;
        if (generateCustomPromptButton) generateCustomPromptButton.disabled = false;
      }
    }

    // Generar con Nano Banana (IA)
    if (openNanoBananaButton) {
      openNanoBananaButton.addEventListener('click', async () => {
        // Verificar si ya se us√≥ Nano Banana para ESTA tarjeta espec√≠fica (usando el c√≥digo √∫nico)
        const cardCode = PAGE_DATA.code;
        const storageKey = `nanoBananaUsed_${cardCode}`;
        const nanoBananaUsed = localStorage.getItem(storageKey);
        if (nanoBananaUsed === 'true') {
          alert('‚ö†Ô∏è La generaci√≥n de im√°genes con IA solo se puede usar 1 vez por tarjeta. Ya has usado esta funci√≥n para esta tarjeta.');
          return;
        }
        
        // Mostrar alert de advertencia
        const confirmed = confirm('‚ö†Ô∏è IMPORTANTE: La generaci√≥n de im√°genes con IA solo se puede usar 1 vez.\n\n¬øDeseas continuar?');
        if (!confirmed) {
          return;
        }
        
        if (nanoBananaContainer) {
          nanoBananaContainer.style.display = 'block';

          const occasionSelect = document.getElementById('nanoBananaOccasionSelect');
          if (occasionSelect) {
            nanoBananaOccasion = occasionSelect.value || 'valentine';
            occasionSelect.onchange = async () => {
              nanoBananaOccasion = occasionSelect.value || 'valentine';
              // recargar ideas
              if (nanoBananaIdeasGrid) {
                nanoBananaIdeasGrid.innerHTML = '<p style="text-align: center; color: #c44569;">Cargando ideas...</p>';
              }
              try {
                const response = await fetch(`${PAGE_DATA.baseUrl}/api/nano-banana/ideas?occasion=${encodeURIComponent(nanoBananaOccasion)}`);
                if (!response.ok) throw new Error('Error al cargar ideas');
                const data = await response.json();
                const ideas = data.data || [];
                if (nanoBananaIdeasGrid) nanoBananaIdeasGrid.innerHTML = '';
                ideas.forEach((idea) => {
                  const ideaCard = document.createElement('div');
                  ideaCard.style.cssText = 'padding: 12px; background: white; border-radius: 8px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s; text-align: center;';
                  ideaCard.innerHTML = `
                    <div style="font-size: 20px; margin-bottom: 6px;">üçå‚ú®</div>
                    <div style="font-size: 13px; font-weight: 600; color: #c44569; margin-bottom: 4px;">${idea.title}</div>
                    <div style="font-size: 10px; color: #888;">${idea.category || ''}</div>
                  `;
                  ideaCard.addEventListener('mouseenter', () => {
                    ideaCard.style.borderColor = '#ff6b9d';
                    ideaCard.style.transform = 'scale(1.05)';
                    ideaCard.style.boxShadow = '0 4px 12px rgba(255, 107, 157, 0.3)';
                  });
                  ideaCard.addEventListener('mouseleave', () => {
                    ideaCard.style.borderColor = 'transparent';
                    ideaCard.style.transform = 'scale(1)';
                    ideaCard.style.boxShadow = 'none';
                  });
                  ideaCard.addEventListener('click', async () => {
                    await generateNanoBananaImage(idea.prompt);
                  });
                  nanoBananaIdeasGrid.appendChild(ideaCard);
                });
              } catch (error) {
                console.error('Error loading ideas:', error);
                if (nanoBananaIdeasGrid) {
                  nanoBananaIdeasGrid.innerHTML = '<p style="text-align: center; color: #dc2626;">Error al cargar ideas. Intenta de nuevo.</p>';
                }
              }
            };
          }
          
          // Cargar las 14 ideas predefinidas
          if (nanoBananaIdeasGrid) {
            nanoBananaIdeasGrid.innerHTML = '<p style="text-align: center; color: #c44569;">Cargando ideas...</p>';
            
            try {
              const response = await fetch(`${PAGE_DATA.baseUrl}/api/nano-banana/ideas?occasion=${encodeURIComponent(nanoBananaOccasion)}`);
              if (!response.ok) throw new Error('Error al cargar ideas');
              
              const data = await response.json();
              const ideas = data.data || [];
              
              nanoBananaIdeasGrid.innerHTML = '';
              ideas.forEach((idea) => {
                const ideaCard = document.createElement('div');
                ideaCard.style.cssText = 'padding: 12px; background: white; border-radius: 8px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s; text-align: center;';
                ideaCard.innerHTML = `
                  <div style="font-size: 20px; margin-bottom: 6px;">${idea.category === '14 de febrero' ? 'üíù' : idea.category === 'Amor y amistad' ? 'üíï' : 'üéÇ'}</div>
                  <div style="font-size: 13px; font-weight: 600; color: #c44569; margin-bottom: 4px;">${idea.title}</div>
                  <div style="font-size: 10px; color: #888;">${idea.category}</div>
                `;
                
                ideaCard.addEventListener('mouseenter', () => {
                  ideaCard.style.borderColor = '#ff6b9d';
                  ideaCard.style.transform = 'scale(1.05)';
                  ideaCard.style.boxShadow = '0 4px 12px rgba(255, 107, 157, 0.3)';
                });
                ideaCard.addEventListener('mouseleave', () => {
                  ideaCard.style.borderColor = 'transparent';
                  ideaCard.style.transform = 'scale(1)';
                  ideaCard.style.boxShadow = 'none';
                });
                
                ideaCard.addEventListener('click', async () => {
                  // Usar la funci√≥n compartida para generar
                  const ideaPrompt = idea.prompt;
                  await generateNanoBananaImage(ideaPrompt);
                });
                
                nanoBananaIdeasGrid.appendChild(ideaCard);
              });
            } catch (error) {
              console.error('Error loading ideas:', error);
              if (nanoBananaIdeasGrid) {
                nanoBananaIdeasGrid.innerHTML = '<p style="text-align: center; color: #dc2626;">Error al cargar ideas. Intenta de nuevo.</p>';
              }
            }
          }
        }
      });
    }

    if (closeNanoBananaButton) {
      closeNanoBananaButton.addEventListener('click', () => {
        if (nanoBananaContainer) {
          nanoBananaContainer.style.display = 'none';
        }
      });
    }

    // Generar con prompt personalizado
    if (generateCustomPromptButton && nanoBananaCustomPrompt) {
      generateCustomPromptButton.addEventListener('click', async () => {
        const customPrompt = nanoBananaCustomPrompt.value.trim();
        if (!customPrompt) {
          alert('Por favor ingresa una descripci√≥n para generar la imagen.');
          return;
        }
        
        // Mostrar modal de carga
        showNanoBananaLoadingModal();
        
        try {
          await generateNanoBananaImage(customPrompt);
        } finally {
          // Ocultar modal de carga (se oculta tambi√©n en generateNanoBananaImage, pero por si acaso)
          hideNanoBananaLoadingModal();
        }
      });

      // Tambi√©n permitir generar con Enter
      nanoBananaCustomPrompt.addEventListener('keydown', async (e) => {
        if (e.key === 'Enter' && e.ctrlKey) {
          e.preventDefault();
          const customPrompt = nanoBananaCustomPrompt.value.trim();
          if (customPrompt) {
            // Mostrar modal de carga
            showNanoBananaLoadingModal();
            
            try {
              await generateNanoBananaImage(customPrompt);
            } finally {
              // Ocultar modal de carga
              hideNanoBananaLoadingModal();
            }
          }
        }
      });
    }

    // Manejar URL de video y preview
    const videoUrlInput = document.getElementById('videoUrl');
    const videoPreviewContainer = document.getElementById('videoPreviewContainer');
    const videoPreview = document.getElementById('videoPreview');
    const removeVideoBtn = document.getElementById('removeVideo');
    let currentVideoUrl = '';

    // Funci√≥n para obtener oEmbed URL seg√∫n el proveedor
    function getOEmbedUrl(url) {
      if (url.includes('facebook.com') || url.includes('fb.com')) {
        return `https://www.facebook.com/plugins/video.php?href=${encodeURIComponent(url)}&show_text=false&width=500`;
      } else if (url.includes('instagram.com')) {
        // Instagram usa oEmbed API
        return `https://api.instagram.com/oembed?url=${encodeURIComponent(url)}&omitscript=true`;
      } else if (url.includes('tiktok.com')) {
        // TikTok usa oEmbed
        return `https://www.tiktok.com/oembed?url=${encodeURIComponent(url)}`;
      }
      return null;
    }

    // Funci√≥n para detectar la plataforma del video
    function detectVideoPlatform(url) {
      if (!url) return null;
      
      const normalizedUrl = url.toLowerCase().trim();
      
      // Facebook (incluye variaciones: facebook.com, fb.com, m.facebook.com, www.facebook.com)
      if (normalizedUrl.includes('facebook.com') || normalizedUrl.includes('fb.com')) {
        return 'facebook';
      }
      
      // Instagram (incluye variaciones: instagram.com, www.instagram.com)
      if (normalizedUrl.includes('instagram.com')) {
        return 'instagram';
      }
      
      // TikTok (incluye variaciones: tiktok.com, www.tiktok.com, vm.tiktok.com)
      if (normalizedUrl.includes('tiktok.com')) {
        return 'tiktok';
      }
      
      // Twitter/X (incluye variaciones: twitter.com, x.com, www.twitter.com, www.x.com)
      if (normalizedUrl.includes('twitter.com') || normalizedUrl.includes('x.com')) {
        return 'twitter';
      }
      
      return null;
    }

    // Funci√≥n helper para cargar video en un contenedor
    async function loadVideoInContainer(videoUrl, containerElement, displayElement) {
      if (!videoUrl || !containerElement) return false;
      
      const platform = detectVideoPlatform(videoUrl);
      
      if (!platform) {
        console.warn('Plataforma de video no soportada:', videoUrl);
        return false;
      }

      try {
        if (platform === 'facebook') {
          const iframeUrl = `https://www.facebook.com/plugins/video.php?href=${encodeURIComponent(videoUrl)}&show_text=false&width=500&height=281`;
          containerElement.innerHTML = `<iframe src="${iframeUrl}" width="500" height="281" style="border:none;overflow:hidden;width:100%;max-width:500px;height:281px;" scrolling="no" frameborder="0" allowfullscreen="true" allow="autoplay; clipboard-write; encrypted-media; picture-in-picture; web-share"></iframe>`;
          if (displayElement) displayElement.style.display = 'block';
          return true;
        } else if (platform === 'instagram') {
          const response = await fetch(`https://api.instagram.com/oembed?url=${encodeURIComponent(videoUrl)}`);
          if (!response.ok) throw new Error('Instagram oEmbed failed');
          const data = await response.json();
          if (data.html) {
            containerElement.innerHTML = data.html;
            if (displayElement) displayElement.style.display = 'block';
            return true;
          }
        } else if (platform === 'tiktok') {
          const response = await fetch(`https://www.tiktok.com/oembed?url=${encodeURIComponent(videoUrl)}`);
          if (!response.ok) throw new Error('TikTok oEmbed failed');
          const data = await response.json();
          if (data.html) {
            containerElement.innerHTML = data.html;
            if (displayElement) displayElement.style.display = 'block';
            return true;
          }
        } else if (platform === 'twitter') {
          const response = await fetch(`https://publish.twitter.com/oembed?url=${encodeURIComponent(videoUrl)}`);
          if (!response.ok) throw new Error('Twitter oEmbed failed');
          const data = await response.json();
          if (data.html) {
            containerElement.innerHTML = data.html;
            if (displayElement) displayElement.style.display = 'block';
            return true;
          }
        }
      } catch (error) {
        console.error('Error loading video:', error);
        return false;
      }
      
      return false;
    }

    // Funci√≥n para cargar preview del video
    async function loadVideoPreview(url) {
      if (!url || !url.trim()) {
        if (videoPreviewContainer) videoPreviewContainer.style.display = 'none';
        return;
      }

      currentVideoUrl = url.trim();
      
      if (videoPreviewContainer) {
        videoPreviewContainer.style.display = 'block';
      }

      if (videoPreview) {
        videoPreview.innerHTML = '<p style="color: white;">Cargando preview...</p>';
      }

      try {
        const platform = detectVideoPlatform(currentVideoUrl);
        
        if (!platform) {
          if (videoPreview) {
            videoPreview.innerHTML = '<p style="color: white;">URL no soportada. Solo se aceptan videos de Facebook, Instagram, TikTok o Twitter/X.</p>';
          }
          return;
        }

        // Para Facebook, usar iframe directamente
        if (platform === 'facebook') {
          const iframeUrl = `https://www.facebook.com/plugins/video.php?href=${encodeURIComponent(currentVideoUrl)}&show_text=false&width=500&height=281`;
          if (videoPreview) {
            videoPreview.innerHTML = `<iframe src="${iframeUrl}" width="500" height="281" style="border:none;overflow:hidden;width:100%;max-width:500px;height:281px;" scrolling="no" frameborder="0" allowfullscreen="true" allow="autoplay; clipboard-write; encrypted-media; picture-in-picture; web-share"></iframe>`;
          }
        } 
        // Para Instagram, usar oEmbed
        else if (platform === 'instagram') {
          const oembedUrl = `https://api.instagram.com/oembed?url=${encodeURIComponent(currentVideoUrl)}`;
          const response = await fetch(oembedUrl);
          if (!response.ok) {
            throw new Error('Instagram oEmbed failed');
          }
          const data = await response.json();
          if (videoPreview) {
            videoPreview.innerHTML = data.html || `<p style="color: white;">Preview no disponible</p>`;
          }
        }
        // Para TikTok, usar oEmbed
        else if (platform === 'tiktok') {
          const oembedUrl = `https://www.tiktok.com/oembed?url=${encodeURIComponent(currentVideoUrl)}`;
          const response = await fetch(oembedUrl);
          if (!response.ok) {
            throw new Error('TikTok oEmbed failed');
          }
          const data = await response.json();
          if (videoPreview) {
            videoPreview.innerHTML = data.html || `<p style="color: white;">Preview no disponible</p>`;
          }
        }
        // Para Twitter/X, usar oEmbed
        else if (platform === 'twitter') {
          const oembedUrl = `https://publish.twitter.com/oembed?url=${encodeURIComponent(currentVideoUrl)}`;
          const response = await fetch(oembedUrl);
          if (!response.ok) {
            throw new Error('Twitter oEmbed failed');
          }
          const data = await response.json();
          if (videoPreview) {
            videoPreview.innerHTML = data.html || `<p style="color: white;">Preview no disponible</p>`;
          }
        }
      } catch (error) {
        console.error('Error loading video preview:', error);
        if (videoPreview) {
          videoPreview.innerHTML = '<p style="color: white;">Error al cargar preview. Verifica que la URL sea v√°lida y que el video sea p√∫blico.</p>';
        }
      }
    }

    // Event listener para el input de video
    if (videoUrlInput) {
      let videoUrlTimeout;
      videoUrlInput.addEventListener('input', (e) => {
        clearTimeout(videoUrlTimeout);
        const url = e.target.value.trim();
        
        if (!url) {
          if (videoPreviewContainer) videoPreviewContainer.style.display = 'none';
          currentVideoUrl = '';
          return;
        }

        // Validar que sea una URL v√°lida
        try {
          new URL(url);
          // Esperar 1 segundo despu√©s de que el usuario deje de escribir
          videoUrlTimeout = setTimeout(() => {
            loadVideoPreview(url);
          }, 1000);
        } catch (error) {
          if (videoPreview) {
            videoPreview.innerHTML = '<p style="color: white;">URL inv√°lida</p>';
          }
        }
      });
    }

    // Bot√≥n para eliminar video
    if (removeVideoBtn) {
      removeVideoBtn.addEventListener('click', () => {
        if (videoUrlInput) videoUrlInput.value = '';
        if (videoPreviewContainer) videoPreviewContainer.style.display = 'none';
        currentVideoUrl = '';
      });
    }


    // Manejar checkbox de PIN
    if (enablePinCheckbox && pinInputContainer && pinInput) {
      enablePinCheckbox.addEventListener('change', (e) => {
        if (e.target.checked) {
          pinInputContainer.style.display = 'block';
          pinInput.required = true;
        } else {
          pinInputContainer.style.display = 'none';
          pinInput.required = false;
          pinInput.value = '';
        }
      });
      
      // Validar que solo sean n√∫meros y m√°ximo 4 d√≠gitos
      pinInput.addEventListener('input', (e) => {
        e.target.value = e.target.value.replace(/[^0-9]/g, '').slice(0, 4);
      });
    }

    // Eliminar imagen seleccionada
    if (removeImage) {
      removeImage.addEventListener('click', () => {
        selectedImageFile = null;
        imagePreviewContainer.style.display = 'none';
        if (imageOptionsContainer) imageOptionsContainer.style.display = 'grid';
        if (wallpaperOptionContainer) wallpaperOptionContainer.style.display = 'none';
        if (useImageAsWallpaperCheckbox) useImageAsWallpaperCheckbox.checked = false;
        if (imageUpload) imageUpload.value = '';
        if (imagePreview) imagePreview.src = '';
      });
    }

    const headerTitle = document.getElementById('headerTitle');

    // Funci√≥n para actualizar el t√≠tulo del header con cuenta regresiva
    function updateHeaderTitle() {
      if (PAGE_DATA.isPersonalized) {
        const remaining = PAGE_DATA.maxPlays - PAGE_DATA.playCount;
        const expirationDate = new Date('2026-02-14T00:00:00');
        const expirationDateStr = expirationDate.toLocaleDateString('es-ES', { 
          day: '2-digit', 
          month: '2-digit', 
          year: 'numeric' 
        }) + ' 12:00 AM';
        
        // Remover clases de animaci√≥n anteriores
        headerTitle.classList.remove('warning', 'danger');
        
        if (isExpired()) {
          headerTitle.textContent = '‚è∞ Tu tarjeta ha expirado';
          headerTitle.classList.add('danger');
        } else if (remaining <= 0) {
          headerTitle.textContent = 'üîí Tu tarjeta se ha autodestruido';
          headerTitle.classList.add('danger');
        } else if (remaining === 1) {
          headerTitle.textContent = `‚ö†Ô∏è Puedes ver la tarjeta 1 vez m√°s antes del ${expirationDateStr}`;
          headerTitle.classList.add('danger');
        } else {
          headerTitle.textContent = `‚ú® Puedes ver la tarjeta ${remaining} veces m√°s antes del ${expirationDateStr}`;
          if (remaining <= 2) {
            headerTitle.classList.add('warning');
          }
        }
      } else {
        headerTitle.textContent = 'Crea tu Tarjeta';
      }
    }

    // Manejar PIN si la p√°gina tiene uno
    if (PAGE_DATA.hasPin) {
      if (pinLockContainer) pinLockContainer.style.display = 'flex';
      if (mainContainer) mainContainer.style.display = 'none';

      // Focus en el primer input
      if (pinInputs[0]) pinInputs[0].focus();

      // Manejar entrada de teclado
      pinInputs.forEach((input, index) => {
        if (!input) return;
        input.addEventListener('input', (e) => {
          const value = e.target.value.replace(/[^0-9]/g, '');
          e.target.value = value;
          if (value && index < 3 && pinInputs[index + 1]) {
            pinInputs[index + 1].focus();
          }
          if (value && index === 3) {
            verifyPin();
          }
        });

        input.addEventListener('keydown', (e) => {
          if (e.key === 'Backspace' && !e.target.value && index > 0 && pinInputs[index - 1]) {
            pinInputs[index - 1].focus();
          }
        });

        input.addEventListener('paste', (e) => {
          e.preventDefault();
          const pasted = e.clipboardData.getData('text').slice(0, 4);
          if (/^\d{4}$/.test(pasted)) {
            pasted.split('').forEach((digit, i) => {
              if (pinInputs[i]) {
                pinInputs[i].value = digit;
              }
            });
            verifyPin();
          }
        });
      });

      // Teclado num√©rico
      pinNumBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const num = btn.getAttribute('data-num');
          const emptyIndex = pinInputs.findIndex(input => input && !input.value);
          if (emptyIndex !== -1 && pinInputs[emptyIndex]) {
            pinInputs[emptyIndex].value = num;
            pinInputs[emptyIndex].focus();
            if (emptyIndex < 3 && pinInputs[emptyIndex + 1]) {
              pinInputs[emptyIndex + 1].focus();
            } else {
              verifyPin();
            }
          }
        });
      });

      if (pinClearBtn) {
        pinClearBtn.addEventListener('click', () => {
          pinInputs.forEach(input => {
            if (input) {
              input.value = '';
              input.style.borderColor = '#d1d5db';
              input.style.background = '#f9fafb';
            }
          });
          if (pinError) pinError.style.display = 'none';
          if (pinInputs[0]) pinInputs[0].focus();
        });
      }

      if (pinBackBtn) {
        pinBackBtn.addEventListener('click', () => {
          for (let i = 3; i >= 0; i--) {
            if (pinInputs[i] && pinInputs[i].value) {
              pinInputs[i].value = '';
              pinInputs[i].focus();
              break;
            }
          }
          if (pinError) pinError.style.display = 'none';
        });
      }

      async function verifyPin() {
        const enteredPin = pinInputs.map(input => input ? input.value : '').join('');
        if (enteredPin.length === 4) {
          try {
            // Verificar PIN en el servidor (m√°s seguro)
            const response = await fetch(`${PAGE_DATA.baseUrl}/api/pages/${PAGE_DATA.code}/verify-pin`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({ pin: enteredPin }),
            });

            const data = await response.json();

            if (data.success && data.data.verified) {
              // PIN correcto, mostrar contenido
              if (pinLockContainer) pinLockContainer.style.display = 'none';
              if (mainContainer) mainContainer.style.display = 'block';
              if (pinError) pinError.style.display = 'none';
            } else {
              // PIN incorrecto
              pinAttempts++;
              if (pinError) pinError.style.display = 'block';
              pinInputs.forEach(input => {
                if (input) {
                  input.value = '';
                  input.style.borderColor = '#ef4444';
                  input.style.background = '#fef2f2';
                  setTimeout(() => {
                    input.style.borderColor = '#d1d5db';
                    input.style.background = '#f9fafb';
                  }, 500);
                }
              });
              setTimeout(() => {
                if (pinInputs[0]) pinInputs[0].focus();
              }, 100);
            }
          } catch (error) {
            console.error('Error verifying PIN:', error);
            // En caso de error, mostrar mensaje
            if (pinError) {
              pinError.style.display = 'block';
              const errorText = pinError.querySelector('p');
              if (errorText) {
                errorText.textContent = 'Error al verificar el PIN. Intenta de nuevo.';
              }
            }
            // Limpiar inputs
            pinInputs.forEach(input => {
              if (input) {
                input.value = '';
                input.style.borderColor = '#d1d5db';
                input.style.background = '#f9fafb';
              }
            });
            setTimeout(() => {
              if (pinInputs[0]) pinInputs[0].focus();
            }, 100);
          }
        }
      }
    } else {
      // No tiene PIN, mostrar contenido directamente
      if (pinLockContainer) pinLockContainer.style.display = 'none';
      if (mainContainer) mainContainer.style.display = 'block';
    }


    // Inicializar vista seg√∫n estado
    // Si la p√°gina ya est√° personalizada, ocultar modal de t√©rminos y cargar contenido
    if (PAGE_DATA.isPersonalized) {
      // Ocultar modal de t√©rminos si la p√°gina ya est√° personalizada
      if (termsModal) {
        termsModal.style.display = 'none';
      }
      termsAccepted = true;
      isAdult = true;
      // Cargar imagen si existe - SIEMPRE se muestra dentro de la carta, incluso si es wallpaper
      if (PAGE_DATA.imageUrl && displayImage && displayImageImg) {
        console.log('Loading image in personalized card (initial):', {
          imageUrl: PAGE_DATA.imageUrl,
          isWallpaper: PAGE_DATA.useImageAsWallpaper
        });
        
        // Si es wallpaper, aplicar como fondo Y tambi√©n mostrar dentro de la carta
        if (PAGE_DATA.useImageAsWallpaper) {
          // Aplicar como fondo
          document.body.style.backgroundImage = `url('${PAGE_DATA.imageUrl}')`;
          document.body.style.backgroundSize = 'cover';
          document.body.style.backgroundPosition = 'center';
          document.body.style.backgroundAttachment = 'fixed';
          document.body.classList.add('has-wallpaper');
          
          // TAMBI√âN mostrar dentro de la carta
          console.log('Setting image src (wallpaper + card):', PAGE_DATA.imageUrl);
          displayImageImg.src = PAGE_DATA.imageUrl;
          displayImage.style.display = 'block';
          displayImage.style.visibility = 'visible';
          displayImage.style.opacity = '1';
        } else {
          // Mostrar la imagen solo dentro de la carta
          console.log('Setting image src:', PAGE_DATA.imageUrl);
          displayImageImg.src = PAGE_DATA.imageUrl;
          displayImage.style.display = 'block';
          displayImage.style.visibility = 'visible';
          displayImage.style.opacity = '1';
        }
        
        displayImageImg.onload = () => {
          console.log('Image loaded in personalized card (initial)');
          displayImage.style.display = 'block';
          displayImage.style.visibility = 'visible';
          displayImage.style.opacity = '1';
        };
        displayImageImg.onerror = () => {
          console.error('Error loading image in personalized card (initial):', PAGE_DATA.imageUrl);
          displayImage.style.display = 'block';
          displayImage.style.visibility = 'visible';
          displayImage.style.opacity = '1';
        };
      } else {
        console.log('Cannot load image - missing elements:', {
          hasImageUrl: !!PAGE_DATA.imageUrl,
          hasDisplayImage: !!displayImage,
          hasDisplayImageImg: !!displayImageImg
        });
      }

      // Cargar video si existe
      const displayVideo = document.getElementById('displayVideo');
      const displayVideoContainer = document.getElementById('displayVideoContainer');
      if (PAGE_DATA.videoUrl && displayVideo && displayVideoContainer) {
        loadVideoInContainer(PAGE_DATA.videoUrl, displayVideoContainer, displayVideo);
      }
    }

    if (!PAGE_DATA.isPersonalized) {
      personalizationForm.classList.add('active');
      // Mostrar modal de t√©rminos si la p√°gina no est√° personalizada
      if (termsModal) {
        termsModal.style.display = 'flex';
      }
    } else {
      // Si ya est√° personalizada, ocultar el modal inmediatamente
      if (termsModal) {
        termsModal.style.display = 'none';
      }
      termsAccepted = true;
      isAdult = true;
      
      // Cargar imagen - SIEMPRE se muestra dentro de la carta, incluso si es wallpaper
      if (PAGE_DATA.imageUrl && displayImage && displayImageImg) {
        // Si es wallpaper, aplicar como fondo Y tambi√©n mostrar dentro de la carta
        if (PAGE_DATA.useImageAsWallpaper) {
          // Aplicar como fondo
          document.body.style.backgroundImage = `url('${PAGE_DATA.imageUrl}')`;
          document.body.style.backgroundSize = 'cover';
          document.body.style.backgroundPosition = 'center';
          document.body.style.backgroundAttachment = 'fixed';
          document.body.classList.add('has-wallpaper');
          
          // TAMBI√âN mostrar dentro de la carta
          console.log('Loading image in personalized view (wallpaper + card):', PAGE_DATA.imageUrl);
          displayImageImg.src = PAGE_DATA.imageUrl;
          displayImage.style.display = 'block';
          displayImage.style.visibility = 'visible';
          displayImage.style.opacity = '1';
        } else {
          // Mostrar la imagen solo dentro de la carta
          console.log('Loading image in personalized view:', PAGE_DATA.imageUrl);
          displayImageImg.src = PAGE_DATA.imageUrl;
          displayImage.style.display = 'block';
          displayImage.style.visibility = 'visible';
          displayImage.style.opacity = '1';
        }
        
        displayImageImg.onload = () => {
          console.log('Image loaded in personalized view');
          displayImage.style.display = 'block';
          displayImage.style.visibility = 'visible';
          displayImage.style.opacity = '1';
        };
        displayImageImg.onerror = () => {
          console.error('Error loading image in personalized view:', PAGE_DATA.imageUrl);
          displayImage.style.display = 'block';
          displayImage.style.visibility = 'visible';
          displayImage.style.opacity = '1';
        };
      }

      // Mostrar video si existe
      const displayVideo = document.getElementById('displayVideo');
      const displayVideoContainer = document.getElementById('displayVideoContainer');
      if (PAGE_DATA.videoUrl && displayVideo && displayVideoContainer) {
        loadVideoInContainer(PAGE_DATA.videoUrl, displayVideoContainer, displayVideo);
      }

      // Mostrar animaci√≥n del sobre primero (en lugar de mostrar directamente el contenido)
      const envelopeAnimationContainer = document.getElementById('envelopeAnimationContainer');
      const envelopeAnimation = document.getElementById('envelopeAnimation');
      const cardMessageAnimation = document.getElementById('cardMessageAnimation');
      const cardImageContainerAnimation = document.getElementById('cardImageContainerAnimation');
      const cardImageAnimation = document.getElementById('cardImageAnimation');
      const instructionTextAnimation = document.querySelector('.instruction-text-animation');

      if (envelopeAnimationContainer && envelopeAnimation) {
        // Actualizar t√≠tulo de la tarjeta con el texto personalizado
        const cardTitleAnimation = document.getElementById('cardTitleAnimation');
        if (cardTitleAnimation) {
          // Si hay mensaje escrito, usarlo como t√≠tulo (limitado a 40 caracteres)
          // Si no, usar el t√≠tulo personalizado o descripci√≥n
          let titleText = '';
          if (PAGE_DATA.writtenMessage) {
            titleText = PAGE_DATA.writtenMessage.length > 40 
              ? PAGE_DATA.writtenMessage.substring(0, 40) + '...' 
              : PAGE_DATA.writtenMessage;
          } else if (PAGE_DATA.title) {
            titleText = PAGE_DATA.title;
          } else if (PAGE_DATA.description) {
            titleText = PAGE_DATA.description.length > 40 
              ? PAGE_DATA.description.substring(0, 40) + '...' 
              : PAGE_DATA.description;
          } else {
            titleText = 'üíå Tarjeta Especial';
          }
          cardTitleAnimation.textContent = titleText;
        }

        // Cargar datos en la tarjeta del sobre
        if (cardMessageAnimation) {
          let messageContent = '';
          if (PAGE_DATA.senderName && PAGE_DATA.recipientName) {
            // Si hay nombres, mostrar estructura con Para/De
            messageContent = `
              <div style="margin-bottom: 8px; font-weight: 600; font-size: 1rem;">Para: ${PAGE_DATA.recipientName}</div>
              <div style="margin-bottom: 8px; font-size: 0.9rem;">De: ${PAGE_DATA.senderName}</div>
              ${PAGE_DATA.writtenMessage ? `<div style="margin-top: 12px; font-size: 0.85rem; line-height: 1.4;">${PAGE_DATA.writtenMessage}</div>` : ''}
            `;
          } else if (PAGE_DATA.writtenMessage) {
            // Si solo hay mensaje escrito, mostrarlo directamente
            messageContent = PAGE_DATA.writtenMessage;
          } else if (PAGE_DATA.description) {
            // Si hay descripci√≥n, usarla
            messageContent = PAGE_DATA.description;
          } else if (PAGE_DATA.title) {
            // Si solo hay t√≠tulo, usarlo
            messageContent = PAGE_DATA.title;
          }
          // Solo actualizar si hay contenido
          if (messageContent) {
            cardMessageAnimation.innerHTML = messageContent;
          }
        }

        // Cargar imagen si existe (mostrar siempre en la tarjeta del sobre)
        if (PAGE_DATA.imageUrl && cardImageContainerAnimation && cardImageAnimation) {
          console.log('Loading image in envelope:', PAGE_DATA.imageUrl);
          cardImageAnimation.src = PAGE_DATA.imageUrl;
          // Mostrar inmediatamente con !important
          cardImageContainerAnimation.style.display = 'block';
          cardImageContainerAnimation.style.visibility = 'visible';
          cardImageAnimation.style.display = 'block';
          cardImageAnimation.style.visibility = 'visible';
          cardImageAnimation.style.opacity = '1';
          
          // Verificar carga
          cardImageAnimation.onload = () => {
            console.log('Image loaded successfully in envelope');
            cardImageContainerAnimation.style.display = 'block';
            cardImageContainerAnimation.style.visibility = 'visible';
          };
          cardImageAnimation.onerror = () => {
            console.error('Error loading image in envelope card:', PAGE_DATA.imageUrl);
            // Mantener visible incluso si hay error
            cardImageContainerAnimation.style.display = 'block';
            cardImageContainerAnimation.style.visibility = 'visible';
          };
        }

        // Mostrar animaci√≥n del sobre
        envelopeAnimationContainer.classList.add('active');

        // Manejar clic en el sobre
        let envelopeOpened = false;
        envelopeAnimation.addEventListener('click', async function() {
          if (!envelopeOpened) {
            envelopeOpened = true;
            this.classList.add('open');
            
            // Incrementar contador de visualizaciones (clicks en el sobre)
            try {
              const response = await fetch(`${PAGE_DATA.baseUrl}/api/pages/${PAGE_DATA.code}/play`, {
                method: 'POST',
              });
              const data = await response.json();
              if (data.success) {
                PAGE_DATA.playCount = data.data.playCount;
                
                // Si la tarjeta fue destruida, mostrar mensaje
                if (data.data.destroyed) {
                  updateLimitsInfo();
                  updateHeaderTitle();
                  // Mostrar mensaje despu√©s de abrir el sobre
                  setTimeout(() => {
                    alert('üîí La tarjeta se ha autodestruido');
                  }, 1500);
                  return;
                }
                
                updateLimitsInfo();
                updateHeaderTitle();
              }
            } catch (error) {
              console.error('Error incrementing view count:', error);
            }
            
            // Ocultar texto de instrucci√≥n
            if (instructionTextAnimation) {
              instructionTextAnimation.style.opacity = '0';
              instructionTextAnimation.style.transition = 'opacity 0.3s';
            }

            // Despu√©s de la animaci√≥n, ocultar el sobre y mostrar el contenido
            setTimeout(() => {
              if (envelopeAnimationContainer) {
                envelopeAnimationContainer.classList.remove('active');
                envelopeAnimationContainer.style.display = 'none';
              }
              
              // Mostrar el contenido normal de la tarjeta
              if (playerView) {
                playerView.classList.add('active');
              }

              // Cargar imagen si existe - SIEMPRE se muestra dentro de la carta, incluso si es wallpaper
              console.log('Loading image after envelope open:', {
                hasImageUrl: !!PAGE_DATA.imageUrl,
                imageUrl: PAGE_DATA.imageUrl,
                isWallpaper: PAGE_DATA.useImageAsWallpaper,
                hasDisplayImage: !!displayImage,
                hasDisplayImageImg: !!displayImageImg
              });
              
              if (PAGE_DATA.imageUrl && displayImage && displayImageImg) {
                // Si es wallpaper, aplicar como fondo Y tambi√©n mostrar dentro de la carta
                if (PAGE_DATA.useImageAsWallpaper) {
                  console.log('Setting image as wallpaper AND in card');
                  // Aplicar como fondo
                  document.body.style.backgroundImage = `url('${PAGE_DATA.imageUrl}')`;
                  document.body.style.backgroundSize = 'cover';
                  document.body.style.backgroundPosition = 'center';
                  document.body.style.backgroundAttachment = 'fixed';
                  document.body.classList.add('has-wallpaper');
                  
                  // TAMBI√âN mostrar dentro de la carta
                  displayImageImg.src = PAGE_DATA.imageUrl;
                  displayImage.style.display = 'block';
                  displayImage.style.visibility = 'visible';
                  displayImage.style.opacity = '1';
                } else {
                  // Mostrar la imagen solo dentro de la carta
                  console.log('Displaying image in card:', PAGE_DATA.imageUrl);
                  displayImageImg.src = PAGE_DATA.imageUrl;
                  displayImage.style.display = 'block';
                  displayImage.style.visibility = 'visible';
                  displayImage.style.opacity = '1';
                }
                
                // Asegurar que se muestre despu√©s de cargar
                displayImageImg.onload = () => {
                  console.log('Image loaded successfully');
                  displayImage.style.display = 'block';
                  displayImage.style.visibility = 'visible';
                  displayImage.style.opacity = '1';
                };
                displayImageImg.onerror = () => {
                  console.error('Error loading image:', PAGE_DATA.imageUrl);
                  // Mantener visible incluso si hay error
                  displayImage.style.display = 'block';
                  displayImage.style.visibility = 'visible';
                  displayImage.style.opacity = '1';
                };
                
                // Forzar visibilidad despu√©s de un momento
                setTimeout(() => {
                  if (PAGE_DATA.imageUrl && displayImage) {
                    console.log('Forcing image visibility');
                    displayImage.style.display = 'block';
                    displayImage.style.visibility = 'visible';
                    displayImage.style.opacity = '1';
                    if (displayImageImg) {
                      displayImageImg.style.display = 'block';
                      displayImageImg.style.visibility = 'visible';
                      displayImageImg.style.opacity = '1';
                    }
                  }
                }, 200);
              } else {
                console.log('Cannot display image - missing requirements');
              }

              // Mostrar video si existe
              const displayVideo = document.getElementById('displayVideo');
              const displayVideoContainer = document.getElementById('displayVideoContainer');
              if (PAGE_DATA.videoUrl && displayVideo && displayVideoContainer) {
                loadVideoInContainer(PAGE_DATA.videoUrl, displayVideoContainer, displayVideo);
              }

              updateLimitsInfo();
              updateHeaderTitle();
            }, 1500); // Esperar a que termine la animaci√≥n del sobre
          }
        });

        // Hacer el sobre focusable para accesibilidad
        envelopeAnimation.setAttribute('tabindex', '0');
        envelopeAnimation.setAttribute('role', 'button');
        envelopeAnimation.setAttribute('aria-label', 'Haz clic para abrir el sobre');

        // Tambi√©n permitir abrir con tecla Enter o Espacio
        envelopeAnimation.addEventListener('keydown', function(e) {
          if ((e.key === 'Enter' || e.key === ' ') && !envelopeOpened) {
            e.preventDefault();
            this.click();
          }
        });
      } else {
        // Si no hay animaci√≥n, mostrar contenido directamente
        if (playerView) {
          playerView.classList.add('active');
        }
        
        // Cargar imagen si existe (cuando no hay animaci√≥n)
        if (PAGE_DATA.imageUrl && displayImage && displayImageImg) {
          console.log('Loading image without animation:', {
            hasImageUrl: !!PAGE_DATA.imageUrl,
            imageUrl: PAGE_DATA.imageUrl,
            isWallpaper: PAGE_DATA.useImageAsWallpaper
          });
          
          // Si es wallpaper, aplicar como fondo Y tambi√©n mostrar dentro de la carta
          if (PAGE_DATA.useImageAsWallpaper) {
            // Aplicar como fondo
            document.body.style.backgroundImage = `url('${PAGE_DATA.imageUrl}')`;
            document.body.style.backgroundSize = 'cover';
            document.body.style.backgroundPosition = 'center';
            document.body.style.backgroundAttachment = 'fixed';
            document.body.classList.add('has-wallpaper');
            
            // TAMBI√âN mostrar dentro de la carta
            console.log('Displaying image in content (no animation, wallpaper + card):', PAGE_DATA.imageUrl);
            displayImageImg.src = PAGE_DATA.imageUrl;
            displayImage.style.display = 'block';
            displayImage.style.visibility = 'visible';
            displayImage.style.opacity = '1';
          } else {
            // Mostrar la imagen solo dentro de la carta
            console.log('Displaying image in content (no animation):', PAGE_DATA.imageUrl);
            displayImageImg.src = PAGE_DATA.imageUrl;
            displayImage.style.display = 'block';
            displayImage.style.visibility = 'visible';
            displayImage.style.opacity = '1';
          }
          
          displayImageImg.onload = () => {
            console.log('Image loaded successfully (no animation)');
            displayImage.style.display = 'block';
            displayImage.style.visibility = 'visible';
            displayImage.style.opacity = '1';
          };
          displayImageImg.onerror = () => {
            console.error('Error loading image (no animation):', PAGE_DATA.imageUrl);
            displayImage.style.display = 'block';
            displayImage.style.visibility = 'visible';
            displayImage.style.opacity = '1';
          };
        }
        
        updateLimitsInfo();
        updateHeaderTitle();
      }
    }

    // Funci√≥n para actualizar el tiempo de grabaci√≥n
    function updateRecordingTime() {
      if (recordingStartTime && mediaRecorder && mediaRecorder.state === 'recording') {
        const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        recordButton.textContent = `‚èπ Detener (${minutes}:${seconds.toString().padStart(2, '0')})`;
      }
    }

    // Grabaci√≥n de audio
    recordButton.addEventListener('click', async () => {
      if (mediaRecorder && mediaRecorder.state === 'recording') {
        // Detener grabaci√≥n
        mediaRecorder.stop();
        recordButton.textContent = 'üé§ Grabar Mensaje';
        recordButton.classList.remove('recording');
        if (recordingTimer) {
          clearInterval(recordingTimer);
          recordingTimer = null;
        }
        recordingStartTime = null;
      } else {
        // Iniciar grabaci√≥n
        try {
          // Verificar si hay un audio previo
          if (audioBlob) {
            if (!confirm('Ya tienes un audio grabado. ¬øDeseas reemplazarlo?')) {
              return;
            }
            // Limpiar audio previo
            audioBlob = null;
            audioChunks = [];
            previewAudio.src = '';
            audioPreview.classList.remove('active');
          }

          const stream = await navigator.mediaDevices.getUserMedia({ 
            audio: {
              echoCancellation: true,
              noiseSuppression: true,
              autoGainControl: true
            } 
          });
          
          recordingStream = stream;
          
          // Detectar el mejor tipo MIME disponible
          let mimeType = 'audio/webm';
          const options = [
            'audio/webm;codecs=opus',
            'audio/webm',
            'audio/ogg;codecs=opus',
            'audio/mp4',
          ];
          
          for (const option of options) {
            if (MediaRecorder.isTypeSupported(option)) {
              mimeType = option;
              break;
            }
          }

          mediaRecorder = new MediaRecorder(stream, { mimeType });
          audioChunks = [];

          mediaRecorder.ondataavailable = (event) => {
            if (event.data && event.data.size > 0) {
              audioChunks.push(event.data);
            }
          };

          mediaRecorder.onstop = () => {
            if (audioChunks.length > 0) {
              // Determinar el tipo MIME del blob
              const blobType = mimeType.split(';')[0] || 'audio/webm';
              audioBlob = new Blob(audioChunks, { type: blobType });
              
              // Verificar que el blob tenga contenido
              if (audioBlob.size === 0) {
                showStatus('Error: La grabaci√≥n est√° vac√≠a. Intenta de nuevo.', 'error');
                return;
              }

              const audioUrl = URL.createObjectURL(audioBlob);
              previewAudio.src = audioUrl;
              audioPreview.classList.add('active');
              
              // Mostrar informaci√≥n del audio
              const sizeMB = (audioBlob.size / (1024 * 1024)).toFixed(2);
              document.getElementById('audioStatus').textContent = 
                `Audio grabado (${sizeMB} MB) - ${blobType}`;
              
              showStatus('‚úÖ Audio grabado exitosamente', 'success');
            } else {
              showStatus('Error: No se captur√≥ ning√∫n audio. Intenta de nuevo.', 'error');
            }
            
            // Detener todos los tracks del stream
            recordingStream.getTracks().forEach(track => {
              track.stop();
            });
            recordingStream = null;
          };

          mediaRecorder.onerror = (event) => {
            console.error('Error en MediaRecorder:', event);
            showStatus('Error durante la grabaci√≥n. Intenta de nuevo.', 'error');
            if (recordingStream) {
              recordingStream.getTracks().forEach(track => track.stop());
              recordingStream = null;
            }
          };

          // Iniciar grabaci√≥n
          recordingStartTime = Date.now();
          mediaRecorder.start(1000); // Capturar datos cada segundo
          recordButton.textContent = '‚èπ Detener (0:00)';
          recordButton.classList.add('recording');
          
          // Actualizar tiempo cada segundo
          recordingTimer = setInterval(updateRecordingTime, 1000);
          
          showStatus('üé§ Grabando...', 'loading');
        } catch (error) {
          console.error('Error accessing microphone:', error);
          let errorMsg = 'No se pudo acceder al micr√≥fono.';
          
          if (error.name === 'NotAllowedError' || error.name === 'PermissionDismissedError') {
            errorMsg = 'Permiso de micr√≥fono denegado. Por favor, permite el acceso al micr√≥fono en la configuraci√≥n de tu navegador.';
          } else if (error.name === 'NotFoundError') {
            errorMsg = 'No se encontr√≥ ning√∫n micr√≥fono. Por favor, conecta un micr√≥fono e intenta de nuevo.';
          } else if (error.name === 'NotReadableError') {
            errorMsg = 'El micr√≥fono est√° siendo usado por otra aplicaci√≥n. Por favor, cierra otras aplicaciones.';
          } else if (error.name === 'OverconstrainedError') {
            errorMsg = 'El micr√≥fono no soporta las caracter√≠sticas requeridas.';
          }
          
          showStatus(errorMsg, 'error');
          
          if (recordingStream) {
            recordingStream.getTracks().forEach(track => track.stop());
            recordingStream = null;
          }
        }
      }
    });

    // Eliminar audio grabado
    deleteAudioBtn.addEventListener('click', () => {
      if (confirm('¬øEst√°s seguro de eliminar el audio grabado?')) {
        // Limpiar blob y URL
        if (previewAudio.src) {
          URL.revokeObjectURL(previewAudio.src);
        }
        audioBlob = null;
        audioChunks = [];
        previewAudio.src = '';
        audioPreview.classList.remove('active');
        
        // Detener grabaci√≥n si est√° activa
        if (mediaRecorder && mediaRecorder.state === 'recording') {
          mediaRecorder.stop();
          recordButton.textContent = 'üé§ Grabar Mensaje';
          recordButton.classList.remove('recording');
          if (recordingTimer) {
            clearInterval(recordingTimer);
            recordingTimer = null;
          }
        }
        
        // Detener stream si est√° activo
        if (recordingStream) {
          recordingStream.getTracks().forEach(track => track.stop());
          recordingStream = null;
        }
        
        showStatus('Audio eliminado', 'success');
        setTimeout(() => {
          statusMessage.classList.remove('active');
        }, 2000);
      }
    });

    // Manejar env√≠o del formulario
    personalizeForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // Verificar que se aceptaron los t√©rminos y es mayor de edad
      if (!termsAccepted || !isAdult) {
        showStatus('Debes aceptar los t√©rminos y condiciones, la pol√≠tica anti-bullying y confirmar que eres mayor de edad para continuar', 'error');
        termsModal.style.display = 'flex';
        return;
      }
      
      // Validar campos
      const senderName = document.getElementById('senderName').value.trim();
      const recipientName = document.getElementById('recipientName').value.trim();
      const writtenMessage = document.getElementById('writtenMessage').value.trim();

      if (!senderName) {
        showStatus('Por favor, ingresa tu nombre', 'error');
        document.getElementById('senderName').focus();
        return;
      }

      if (!recipientName) {
        showStatus('Por favor, ingresa el nombre del destinatario', 'error');
        document.getElementById('recipientName').focus();
        return;
      }

      if (!writtenMessage) {
        showStatus('Por favor, escribe un mensaje', 'error');
        document.getElementById('writtenMessage').focus();
        return;
      }

      if (!audioBlob) {
        showStatus('Por favor, graba un mensaje de voz', 'error');
        recordButton.scrollIntoView({ behavior: 'smooth', block: 'center' });
        return;
      }

      // Verificar tama√±o del archivo (m√°ximo 50MB)
      const maxSize = 50 * 1024 * 1024; // 50MB
      if (audioBlob.size > maxSize) {
        showStatus(`El audio es demasiado grande (${(audioBlob.size / (1024 * 1024)).toFixed(2)} MB). M√°ximo: 50 MB`, 'error');
        return;
      }

      // Detener cualquier grabaci√≥n activa
      if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        if (recordingTimer) {
          clearInterval(recordingTimer);
          recordingTimer = null;
        }
      }

      const formData = new FormData();
      formData.append('senderName', senderName);
      formData.append('recipientName', recipientName);
      formData.append('writtenMessage', writtenMessage);
      
      // Agregar imagen si existe
      if (selectedImageFile) {
        formData.append('image', selectedImageFile);
      }
      
      // Agregar PIN si est√° habilitado
      if (enablePinCheckbox && enablePinCheckbox.checked && pinInput && pinInput.value.length === 4) {
        formData.append('pin', pinInput.value);
      }
      
      // Agregar opci√≥n de wallpaper
      if (useImageAsWallpaperCheckbox && useImageAsWallpaperCheckbox.checked) {
        formData.append('useImageAsWallpaper', 'true');
      }
      
      // Agregar URL de video si existe
      const videoUrlInput = document.getElementById('videoUrl');
      if (videoUrlInput && videoUrlInput.value.trim()) {
        formData.append('videoUrl', videoUrlInput.value.trim());
      }
      
      // Validar PIN si est√° habilitado
      if (enablePinCheckbox && enablePinCheckbox.checked) {
        if (!pinInput || pinInput.value.length !== 4) {
          showStatus('Por favor, ingresa un PIN de 4 d√≠gitos', 'error');
          if (pinInput) pinInput.focus();
          return;
        }
      }
      
      // Determinar la extensi√≥n del archivo basado en el tipo MIME
      let extension = 'webm';
      if (audioBlob.type.includes('ogg')) {
        extension = 'ogg';
      } else if (audioBlob.type.includes('mp4') || audioBlob.type.includes('m4a')) {
        extension = 'm4a';
      } else if (audioBlob.type.includes('wav')) {
        extension = 'wav';
      }
      
      formData.append('audio', audioBlob, `voice-message.${extension}`);

      submitBtn.disabled = true;
      submitBtn.textContent = 'Creando...';
      showStatus('Subiendo audio y creando tu tarjeta...', 'loading');

      try {
        const response = await fetch(`${PAGE_DATA.baseUrl}/api/pages/${PAGE_DATA.code}/personalize`, {
          method: 'PUT',
          body: formData,
        });

        // Verificar si la respuesta es JSON
        let data;
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
          data = await response.json();
        } else {
          const text = await response.text();
          throw new Error(`Error del servidor: ${text}`);
        }

        if (!response.ok) {
          throw new Error(data.message || `Error ${response.status}: ${response.statusText}`);
        }

        if (data.success) {
          showStatus('¬°Tarjeta creada exitosamente! Redirigiendo...', 'success');
          
          // Limpiar URL del blob para liberar memoria
          if (previewAudio.src) {
            URL.revokeObjectURL(previewAudio.src);
          }
          
          // Actualizar datos
          PAGE_DATA.isPersonalized = true;
          if (data.data.audioUrl) {
            audio.src = data.data.audioUrl;
          }
          
          const titleElement = document.querySelector('.player-container h1');
          const descElement = document.querySelector('.player-container .description');
          
          if (titleElement) {
            titleElement.textContent = data.data.title || `De ${data.data.senderName} para ${data.data.recipientName}`;
          }
          if (descElement) {
            descElement.textContent = data.data.description || data.data.writtenMessage;
          }

          // Mostrar imagen si fue subida
          if (data.data.imageUrl) {
            PAGE_DATA.imageUrl = data.data.imageUrl;
            PAGE_DATA.useImageAsWallpaper = data.data.useImageAsWallpaper || false;
            
            // Si la imagen debe usarse como wallpaper, aplicarla
            if (PAGE_DATA.useImageAsWallpaper && PAGE_DATA.imageUrl) {
              document.body.style.backgroundImage = `url('${PAGE_DATA.imageUrl}')`;
              document.body.style.backgroundSize = 'cover';
              document.body.style.backgroundPosition = 'center';
              document.body.style.backgroundAttachment = 'fixed';
              document.body.classList.add('has-wallpaper');
              // Ocultar la imagen del contenido si es wallpaper
              if (displayImage) displayImage.style.display = 'none';
            } else {
              // Mostrar la imagen en el contenido si no es wallpaper
              if (displayImage && PAGE_DATA.imageUrl) {
                displayImageImg.src = PAGE_DATA.imageUrl;
                displayImage.style.display = 'block';
              }
            }
          }

          // Mostrar video si fue agregado
          const displayVideo = document.getElementById('displayVideo');
          const displayVideoContainer = document.getElementById('displayVideoContainer');
          if (data.data.videoUrl && displayVideo && displayVideoContainer) {
            PAGE_DATA.videoUrl = data.data.videoUrl;
            loadVideoInContainer(data.data.videoUrl, displayVideoContainer, displayVideo);
          }

          // Cambiar a vista de reproducci√≥n primero
          setTimeout(() => {
            personalizationForm.classList.remove('active');
            playerView.classList.add('active');
            updateLimitsInfo();
            updateHeaderTitle();
            // Hacer scroll al inicio
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            // Mostrar modal de compartir despu√©s de cambiar la vista
            setTimeout(() => {
              showShareModal(data.data.senderName, data.data.recipientName);
            }, 500);
          }, 2000);
        } else {
          throw new Error(data.message || 'Error al crear la tarjeta');
        }
      } catch (error) {
        console.error('Error:', error);
        let errorMessage = error.message || 'Error al crear la tarjeta';
        
        // Mensajes m√°s amigables
        if (errorMessage.includes('network') || errorMessage.includes('fetch')) {
          errorMessage = 'Error de conexi√≥n. Verifica que el servidor est√© corriendo.';
        } else if (errorMessage.includes('413')) {
          errorMessage = 'El archivo de audio es demasiado grande. Intenta grabar un audio m√°s corto.';
        } else if (errorMessage.includes('400')) {
          errorMessage = 'Datos inv√°lidos. Por favor, verifica que todos los campos est√©n completos.';
        }
        
        showStatus(`Error: ${errorMessage}`, 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Crear Tarjeta';
      }
    });

    function showStatus(message, type) {
      statusMessage.textContent = message;
      statusMessage.className = `status-message active ${type}`;
      setTimeout(() => {
        statusMessage.classList.remove('active');
      }, type === 'error' ? 5000 : 3000);
    }

    // Verificar si est√° expirado
    function isExpired() {
      if (!PAGE_DATA.expirationDate) return false;
      return new Date() > PAGE_DATA.expirationDate;
    }

    // Verificar si puede reproducir
    function canPlay() {
      if (isExpired()) return false;
      return PAGE_DATA.playCount < PAGE_DATA.maxPlays;
    }

    // Mostrar informaci√≥n de l√≠mites
    function updateLimitsInfo() {
      if (isExpired()) {
        limitsInfo.textContent = '‚è∞ Esta tarjeta expir√≥ el 14 de febrero a las 12:00 AM';
        limitsInfo.className = 'limits-info expired';
        playButton.disabled = true;
        audio.disabled = true;
        updateHeaderTitle();
        return;
      }

      const remaining = PAGE_DATA.maxPlays - PAGE_DATA.playCount;
      const expirationDate = new Date('2026-02-14T00:00:00');
      const expirationDateStr = expirationDate.toLocaleDateString('es-ES', { 
        day: '2-digit', 
        month: '2-digit', 
        year: 'numeric' 
      }) + ' 12:00 AM';
      
      if (remaining <= 0) {
        limitsInfo.textContent = 'üîí Has alcanzado el l√≠mite de visualizaciones';
        limitsInfo.className = 'limits-info expired';
        playButton.disabled = true;
        audio.disabled = true;
        updateHeaderTitle();
      } else {
        limitsInfo.textContent = `üëÅÔ∏è Visualizaciones restantes: ${remaining} de ${PAGE_DATA.maxPlays} (expira el ${expirationDateStr})`;
        limitsInfo.className = 'limits-info';
        updateHeaderTitle();
      }
    }

    // Estado del reproductor
    let isPlaying = false;
    let hasIncrementedPlay = false;

    // Actualizar estado cuando el audio se carga
    audio.addEventListener('loadedmetadata', () => {
      status.textContent = 'Audio listo para reproducir';
    });

    audio.addEventListener('canplay', () => {
      status.textContent = 'Audio listo para reproducir';
    });

    audio.addEventListener('error', (e) => {
      status.textContent = 'Error al cargar el audio. Por favor, intenta m√°s tarde.';
      status.style.color = '#dc3545';
      playButton.disabled = true;
      console.error('Error loading audio:', e);
    });

    // Controlar reproducci√≥n desde el bot√≥n
    playButton.addEventListener('click', async () => {
      if (!canPlay()) {
        alert('No puedes reproducir m√°s veces. L√≠mite alcanzado o expirado.');
        return;
      }

      if (isPlaying) {
        audio.pause();
        playButton.textContent = '‚ñ∂';
        playButton.classList.remove('playing');
        isPlaying = false;
      } else {
        // Incrementar contador solo cuando empieza a reproducir
        if (!hasIncrementedPlay) {
          try {
            const response = await fetch(`${PAGE_DATA.baseUrl}/api/pages/${PAGE_DATA.code}/play`, {
              method: 'POST',
            });
            const data = await response.json();
            if (data.success) {
              PAGE_DATA.playCount = data.data.playCount;
              
              // Si la tarjeta fue destruida, mostrar mensaje y ocultar reproductor
              if (data.data.destroyed) {
                updateLimitsInfo();
                updateHeaderTitle();
                showStatus('üîí La tarjeta se ha autodestruido', 'error');
                return;
              }
              
              updateLimitsInfo();
              updateHeaderTitle();
              hasIncrementedPlay = true;
            }
          } catch (error) {
            console.error('Error incrementing play count:', error);
          }
        }

        audio.play().then(() => {
          playButton.textContent = '‚è∏';
          playButton.classList.add('playing');
          isPlaying = true;
          status.textContent = 'Reproduciendo...';
        }).catch((error) => {
          console.error('Error playing audio:', error);
          status.textContent = 'Error al reproducir el audio';
          status.style.color = '#dc3545';
        });
      }
    });

    // Sincronizar con los controles nativos del audio
    audio.addEventListener('play', () => {
      playButton.textContent = '‚è∏';
      playButton.classList.add('playing');
      isPlaying = true;
      status.textContent = 'Reproduciendo...';
    });

    audio.addEventListener('pause', () => {
      playButton.textContent = '‚ñ∂';
      playButton.classList.remove('playing');
      isPlaying = false;
      status.textContent = 'Pausado';
    });

    audio.addEventListener('ended', () => {
      playButton.textContent = '‚ñ∂';
      playButton.classList.remove('playing');
      isPlaying = false;
      hasIncrementedPlay = false;
      status.textContent = 'Audio finalizado';
    });

    // Mostrar progreso
    audio.addEventListener('timeupdate', () => {
      if (audio.duration) {
        const percent = (audio.currentTime / audio.duration) * 100;
        if (isPlaying) {
          status.textContent = `Reproduciendo... ${Math.round(percent)}%`;
        }
      }
    });

    // Funci√≥n para mostrar modal de compartir
    function showShareModal(senderName, recipientName) {
      const shareModal = document.getElementById('shareModal');
      const shareModalMessage = document.getElementById('shareModalMessage');
      const closeShareModal = document.getElementById('closeShareModal');
      const shareInstagram = document.getElementById('shareInstagram');
      const shareFacebook = document.getElementById('shareFacebook');
      const shareWhatsApp = document.getElementById('shareWhatsApp');
      const shareTwitter = document.getElementById('shareTwitter');
      const copyUrlBtn = document.getElementById('copyUrl');
      const copyUrlFeedback = document.getElementById('copyUrlFeedback');

      if (!shareModal) {
        console.error('Share modal not found');
        return;
      }

      // Actualizar mensaje
      if (shareModalMessage) {
        shareModalMessage.textContent = `${senderName || 'Alguien'} para ${recipientName || 'ti'}`;
      }

      // URL relativa de la tarjeta
      const cardUrl = `${PAGE_DATA.baseUrl}/page/${PAGE_DATA.code}`;
      const shareText = `${senderName || 'Alguien'} para ${recipientName || 'ti'}`;
      const fullShareText = `${shareText} - ${cardUrl}`;

      // Limpiar event listeners anteriores para evitar duplicados
      const newCloseBtn = closeShareModal?.cloneNode(true);
      if (closeShareModal && newCloseBtn) {
        closeShareModal.parentNode?.replaceChild(newCloseBtn, closeShareModal);
      }

      // Mostrar modal con display flex
      shareModal.style.display = 'flex';
      shareModal.style.alignItems = 'center';
      shareModal.style.justifyContent = 'center';

      // Cerrar modal - usar el nuevo elemento si existe
      const closeBtn = document.getElementById('closeShareModal');
      if (closeBtn) {
        closeBtn.onclick = () => {
          shareModal.style.display = 'none';
        };
      }

      // Compartir en Instagram (abre en nueva pesta√±a con el texto)
      const instagramBtn = document.getElementById('shareInstagram');
      if (instagramBtn) {
        instagramBtn.onclick = () => {
          // Instagram no tiene API directa, abrimos la app o web
          const instagramUrl = `https://www.instagram.com/`;
          window.open(instagramUrl, '_blank');
          // Mostrar mensaje para que el usuario pegue manualmente
          if (navigator.clipboard) {
            navigator.clipboard.writeText(fullShareText).then(() => {
              alert('Texto copiado. P√©galo en tu publicaci√≥n de Instagram.');
            });
          }
        };
      }

      // Compartir en Facebook
      const facebookBtn = document.getElementById('shareFacebook');
      if (facebookBtn) {
        facebookBtn.onclick = () => {
          const facebookUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(cardUrl)}&quote=${encodeURIComponent(shareText)}`;
          window.open(facebookUrl, '_blank', 'width=600,height=400');
        };
      }

      // Compartir en WhatsApp
      const whatsappBtn = document.getElementById('shareWhatsApp');
      if (whatsappBtn) {
        whatsappBtn.onclick = () => {
          // Mensaje personalizado para WhatsApp
          const whatsappMessage = `te mande una tarjeta virtual, da click aqui\n${shareText} - ${cardUrl}`;
          const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(whatsappMessage)}`;
          window.open(whatsappUrl, '_blank');
        };
      }

      // Compartir en Twitter/X
      const twitterBtn = document.getElementById('shareTwitter');
      if (twitterBtn) {
        twitterBtn.onclick = () => {
          const twitterText = `${shareText} - ${cardUrl}`;
          const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(twitterText)}&url=${encodeURIComponent(cardUrl)}`;
          window.open(twitterUrl, '_blank', 'width=600,height=400');
        };
      }

      // Copiar URL
      const copyBtn = document.getElementById('copyUrl');
      if (copyBtn) {
        copyBtn.onclick = async () => {
          try {
            if (navigator.clipboard) {
              await navigator.clipboard.writeText(cardUrl);
              const feedback = document.getElementById('copyUrlFeedback');
              if (feedback) {
                feedback.style.display = 'block';
                setTimeout(() => {
                  feedback.style.display = 'none';
                }, 2000);
              }
            } else {
              // Fallback para navegadores antiguos
              const textArea = document.createElement('textarea');
              textArea.value = cardUrl;
              document.body.appendChild(textArea);
              textArea.select();
              document.execCommand('copy');
              document.body.removeChild(textArea);
              const feedback = document.getElementById('copyUrlFeedback');
              if (feedback) {
                feedback.style.display = 'block';
                setTimeout(() => {
                  feedback.style.display = 'none';
                }, 2000);
              }
            }
          } catch (error) {
            console.error('Error copying URL:', error);
            alert('Error al copiar URL. Por favor, c√≥piala manualmente: ' + cardUrl);
          }
        };
      }
    }
  </script>
</body>
</html>
